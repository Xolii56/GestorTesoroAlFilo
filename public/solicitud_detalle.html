<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solicitud — Detalle</title>

  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.det-main{ padding:1.25rem; max-width:980px; margin:0 auto; }
    .det-header-row{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:.75rem; flex-wrap:wrap; margin-bottom:1rem;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="det-main">
    <div class="det-header-row">
      <div>
        <h2>Detalle de solicitud</h2>
        <p style="opacity:.8;margin-top:.25rem;font-size:.9rem;">Información completa de la solicitud.</p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.close()">Cerrar</button>
    </div>

    <div id="cmp-det-01"></div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';
    import { loadComponentById } from './modules/ui_components.js';

    function formatStatus(st) {
      const map = {
        pendiente: 'Pendiente',
        aprobada: 'Aprobada',
        rechazada: 'Rechazada',
        completada: 'Completada',
        cancelada: 'Cancelada'
      };
      return map[st] || st || '—';
    }
    function renderTipo(tipo){
      if (!tipo) return '—';
      return tipo === 'compra' ? 'Compra' : 'Venta';
    }
    function tipoTagClass(tipo){
      return (tipo === 'venta') ? 'tag tag--venta' : 'tag tag--compra';
    }
    function statusTagClass(st){
      return `tag tag--${st}`;
    }
    function toLocale(dt){
      if (!dt) return '—';
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    function findValueByLabel(root, labelText){
      const labels = Array.from(root.querySelectorAll('.detail-grid .detail-label'));
      const lab = labels.find(l => (l.textContent || '').trim() === labelText);
      if (!lab) return null;
      const val = lab.nextElementSibling;
      if (!val || !val.classList.contains('detail-value')) return null;
      return val;
    }

    function setValueText(root, label, value){
      const v = findValueByLabel(root, label);
      if (!v) return false;
      v.textContent = (value === undefined || value === null || value === '') ? '—' : String(value);
      return true;
    }

    function setValueTag(root, label, cssClass, text){
      const v = findValueByLabel(root, label);
      if (!v) return false;
      v.innerHTML = `<span class="${cssClass}">${text}</span>`;
      return true;
    }

    function setLogs(root, html){
      const v = findValueByLabel(root, 'Logs');
      if (!v) return false;
      const box = v.querySelector('.logs-box');
      if (!box) return false;
      box.innerHTML = html || '';
      return true;
    }

    function setSignature(root, whoTitle, result){
      const cards = Array.from(root.querySelectorAll('.signature-card'));
      const card = cards.find(c => (c.querySelector('.signature-title')?.textContent || '').trim() === whoTitle);
      if (!card) return false;

      const box = card.querySelector('.signature-box');
      if (!box) return false;

      const r = (result || 'pendiente').toLowerCase();
      box.classList.remove('signature-box--pending', 'signature-box--ok', 'signature-box--ko');

      if (r === 'ok') box.classList.add('signature-box--ok');
      else if (r === 'ko') box.classList.add('signature-box--ko');
      else box.classList.add('signature-box--pending');

      box.textContent = 'ENTREGA';
      return true;
    }

    function wipeDemo(detRoot){
      // Importante: DET-01 trae valores demo. Los neutralizamos.
      setValueText(detRoot, 'ID solicitud', '—');
      setValueTag(detRoot, 'Tipo de solicitud', 'tag', '—');
      setValueTag(detRoot, 'Estado de solicitud', 'tag', '—');
      setValueText(detRoot, 'Solicitante', '—');
      setValueText(detRoot, 'Material', '—');
      setValueText(detRoot, 'Cantidad', '—');
      setValueText(detRoot, 'Preferencia de entrega', '—');
      setValueText(detRoot, 'Lugar de entrega', '—');
      setValueText(detRoot, 'Fecha límite de entrega', '—');

      setSignature(detRoot, 'Solicitante', 'pendiente');
      setSignature(detRoot, 'Tesoro', 'pendiente');

      setLogs(detRoot, '<span class="text-muted">Cargando datos…</span>');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 0) Castear DET-01 (NO SE MODIFICA)
      await loadComponentById('./components/det-01.html', 'cmp-det-01');
      const detRoot = document.getElementById('cmp-det-01');
      wipeDemo(detRoot);

      // 1) Sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = './index.html'; return; }

      // 2) org_status
      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // 3) Header
      if (typeof window.loadHeader === 'function') await window.loadHeader('app');
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => { await supa.auth.signOut(); window.location.href = "./index.html"; },
          () => { window.location.href = './perfil.html'; }
        );
      }

      // 4) ID URL
      const params = new URLSearchParams(window.location.search);
      const rawId = params.get('id');
      if (!rawId) {
        alert('No se ha proporcionado un ID de solicitud (?id=...).');
        setLogs(detRoot, '<span class="text-muted">Falta el parámetro ?id=...</span>');
        return;
      }

      const cleanedId = String(rawId).replace(/^#/, '').trim();
      const isNumeric = /^[0-9]+$/.test(cleanedId);
      const idValue = isNumeric ? Number(cleanedId) : cleanedId;

      // 5) Query MINIMAL a requests (SIN JOINS) → esto evita petar por policies ajenas
      const { data: req, error: reqError } = await supa
        .from('requests')
        .select(`
          id,
          request_type,
          item_id,
          quantity,
          status,
          created_at,
          due_date,
          approved_at,
          completed_at,
          warehouse_id,
          preferred_warehouse_id,
          requester_discord_id,
          warehouse_sign_result,
          warehouse_sign_at,
          requester_sign_result,
          requester_sign_at
        `)
        .eq('id', idValue)
        .maybeSingle();

      if (reqError || !req) {
        console.error('requests select error:', reqError);
        alert('No se pudo cargar la solicitud (error de base de datos / policies).');
        setLogs(detRoot, `<span class="text-muted">Error cargando solicitud. Mira consola para detalles.</span>`);
        return;
      }

      // 6) Con lo mínimo ya pintamos datos reales
      setValueText(detRoot, 'ID solicitud', `#${req.id}`);
      setValueTag(detRoot, 'Tipo de solicitud', tipoTagClass(req.request_type), renderTipo(req.request_type));
      setValueTag(detRoot, 'Estado de solicitud', statusTagClass(req.status || 'pendiente'), formatStatus(req.status || 'pendiente'));
      setValueText(detRoot, 'Cantidad', req.quantity ?? '—');
      setValueText(detRoot, 'Fecha límite de entrega', req.due_date || '—');

      setSignature(detRoot, 'Solicitante', req.requester_sign_result || 'pendiente');
      setSignature(detRoot, 'Tesoro', req.warehouse_sign_result || 'pendiente');

      // 7) Cargar extra en queries separadas (si fallan por policies NO rompemos la página)
      // 7.1 Solicitante
      let requesterName = req.requester_discord_id || '—';
      if (req.requester_discord_id) {
        const { data: uRow, error: uErr } = await supa
          .from('users')
          .select('handle_name, discord_username')
          .eq('id', req.requester_discord_id)
          .maybeSingle();

        if (!uErr && uRow) requesterName = uRow.handle_name || uRow.discord_username || req.requester_discord_id;
      }
      setValueText(detRoot, 'Solicitante', requesterName);

      // 7.2 Material (commodities_master)
      let itemName = req.item_id || '—';
      if (req.item_id) {
        const { data: cmRow, error: cmErr } = await supa
          .from('commodities_master')
          .select('name, symbol')
          .eq('id', req.item_id)
          .maybeSingle();

        if (!cmErr && cmRow) itemName = cmRow.symbol ? `${cmRow.name} (${cmRow.symbol})` : cmRow.name;
      }
      setValueText(detRoot, 'Material', itemName);

      // 7.3 Preferencia / Lugar (warehouses)
      let preferredName = 'Cualquier almacén';
      if (req.preferred_warehouse_id) {
        const { data: pw, error: pwErr } = await supa
          .from('warehouses')
          .select('name')
          .eq('id', req.preferred_warehouse_id)
          .maybeSingle();
        if (!pwErr && pw?.name) preferredName = pw.name;
        else preferredName = `ID ${req.preferred_warehouse_id}`;
      }
      setValueText(detRoot, 'Preferencia de entrega', preferredName);

      let whName = '—';
      if (req.warehouse_id) {
        const { data: w, error: wErr } = await supa
          .from('warehouses')
          .select('name')
          .eq('id', req.warehouse_id)
          .maybeSingle();
        if (!wErr && w?.name) whName = w.name;
        else whName = `ID ${req.warehouse_id}`;
      }
      setValueText(detRoot, 'Lugar de entrega', whName);

      // 8) Logs reales mínimos
      const logs = [];
      if (req.created_at) logs.push(`${toLocale(req.created_at)} · Solicitud creada`);
      if (req.approved_at) logs.push(`${toLocale(req.approved_at)} · Solicitud aprobada`);
      if (req.requester_sign_at) logs.push(`${toLocale(req.requester_sign_at)} · Firma solicitante · ${req.requester_sign_result || 'pendiente'}`);
      if (req.warehouse_sign_at) logs.push(`${toLocale(req.warehouse_sign_at)} · Firma tesoro · ${req.warehouse_sign_result || 'pendiente'}`);
      if (req.completed_at) logs.push(`${toLocale(req.completed_at)} · Solicitud completada`);

      setLogs(detRoot, logs.length ? logs.join('<br>') : '<span class="text-muted">Sin eventos adicionales.</span>');
    });
  </script>
</body>
</html>
