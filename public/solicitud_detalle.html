<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solicitud — Detalle</title>

  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.det-main{ padding:1.25rem; max-width:980px; margin:0 auto; }
    .det-header-row{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:.75rem; flex-wrap:wrap; margin-bottom:1rem;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="det-main">
    <div class="det-header-row">
      <div>
        <h2>Detalle de solicitud</h2>
        <p style="opacity:.8;margin-top:.25rem;font-size:.9rem;">Información completa de la solicitud.</p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.close()">Cerrar</button>
    </div>

    <div id="cmp-det-01"></div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';
    import { loadComponentById } from './modules/ui_components.js';

    const $ = (sel, root=document) => root.querySelector(sel);

    function formatStatus(st) {
      const map = {
        pendiente: 'Pendiente',
        aprobada: 'Aprobada',
        rechazada: 'Rechazada',
        completada: 'Completada',
        cancelada: 'Cancelada'
      };
      return map[st] || st || '—';
    }
    function renderTipo(tipo){
      if (!tipo) return '—';
      return tipo === 'compra' ? 'Compra' : 'Venta';
    }
    function tipoTagClass(tipo){
      return (tipo === 'venta') ? 'tag tag--venta' : 'tag tag--compra';
    }
    function statusTagClass(st){
      return `tag tag--${st}`;
    }
    function toLocale(dt){
      if (!dt) return '—';
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    function findValueByLabel(root, labelText){
      const labels = Array.from(root.querySelectorAll('.detail-grid .detail-label'));
      const lab = labels.find(l => (l.textContent || '').trim() === labelText);
      if (!lab) return null;
      // la estructura es label + value como hermanos consecutivos
      const val = lab.nextElementSibling;
      if (!val || !val.classList.contains('detail-value')) return null;
      return val;
    }

    function setValueText(root, label, value){
      const v = findValueByLabel(root, label);
      if (!v) return false;
      v.textContent = (value === undefined || value === null || value === '') ? '—' : String(value);
      return true;
    }

    function setValueTag(root, label, cssClass, text){
      const v = findValueByLabel(root, label);
      if (!v) return false;
      v.innerHTML = `<span class="${cssClass}">${text}</span>`;
      return true;
    }

    function setLogs(root, html){
      const v = findValueByLabel(root, 'Logs');
      if (!v) return false;
      const box = v.querySelector('.logs-box');
      if (!box) return false;
      box.innerHTML = html || '';
      return true;
    }

    function setSignature(root, whoTitle, result){
      const cards = Array.from(root.querySelectorAll('.signature-card'));
      const card = cards.find(c => (c.querySelector('.signature-title')?.textContent || '').trim() === whoTitle);
      if (!card) return false;

      const box = card.querySelector('.signature-box');
      if (!box) return false;

      const r = (result || 'pendiente').toLowerCase();
      box.classList.remove('signature-box--pending', 'signature-box--ok', 'signature-box--ko');

      if (r === 'ok') box.classList.add('signature-box--ok');
      else if (r === 'ko') box.classList.add('signature-box--ko');
      else box.classList.add('signature-box--pending');

      box.textContent = 'Entrega';
      return true;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 0) Casteo DET-01 (NO SE MODIFICA)
      await loadComponentById('./components/det-01.html', 'cmp-det-01');
      const detRoot = document.getElementById('cmp-det-01');

      // 1) Sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = './index.html'; return; }

      // 2) org_status
      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // 3) Header
      if (typeof window.loadHeader === 'function') await window.loadHeader('app');
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => { await supa.auth.signOut(); window.location.href = "./index.html"; },
          () => { window.location.href = './perfil.html'; }
        );
      }

      // 4) ID de la URL (el botón Ver debe abrir ?id=...)
      const params = new URLSearchParams(window.location.search);
      const rawId = params.get('id');
      if (!rawId) {
        alert('No se ha proporcionado un ID de solicitud (?id=...).');
        return;
      }
      const cleanedId = String(rawId).replace(/^#/, '').trim();

      // 5) Cargar solicitud (acepta id numérico o uuid/texto)
      const isNumeric = /^[0-9]+$/.test(cleanedId);
      const idValue = isNumeric ? Number(cleanedId) : cleanedId;

      const { data: req, error: reqError } = await supa
        .from('requests')
        .select(`
          id,
          request_type,
          item_id,
          quantity,
          status,
          created_at,
          due_date,
          approved_at,
          completed_at,
          warehouse_id,
          preferred_warehouse_id,
          requester_discord_id,
          warehouse_sign_result,
          warehouse_sign_at,
          requester_sign_result,
          requester_sign_at,
          commodities_master(name, symbol),
          warehouses:warehouse_id(id, name),
          preferred_wh:preferred_warehouse_id(id, name)
        `)
        .eq('id', idValue)
        .maybeSingle();

      if (reqError) {
        console.error('solicitud_detalle -> error select:', reqError);
        alert('No se pudo cargar la solicitud (error de base de datos / policies).');
        return;
      }
      if (!req) {
        alert('No se pudo cargar la solicitud (no existe o no tienes permisos).');
        return;
      }

      // 6) Solicitante
      let requesterName = req.requester_discord_id || '—';
      if (req.requester_discord_id) {
        const { data: uRow } = await supa
          .from('users')
          .select('handle_name, discord_username')
          .eq('id', req.requester_discord_id)
          .maybeSingle();
        requesterName = uRow?.handle_name || uRow?.discord_username || req.requester_discord_id;
      }

      // 7) Ítem
      const cm = req.commodities_master;
      const itemName = cm
        ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
        : (req.item_id || '—');

      // 8) Pintar DET-01 por labels (sin tocar el componente)
      setValueText(detRoot, 'ID solicitud', `#${req.id}`);
      setValueTag(detRoot, 'Tipo de solicitud', tipoTagClass(req.request_type), renderTipo(req.request_type));
      setValueTag(detRoot, 'Estado de solicitud', statusTagClass(req.status || 'pendiente'), formatStatus(req.status || 'pendiente'));
      setValueText(detRoot, 'Solicitante', requesterName);
      setValueText(detRoot, 'Material', itemName);
      setValueText(detRoot, 'Cantidad', req.quantity ?? '—');

      const prefName =
        req.preferred_wh?.name ||
        (req.preferred_warehouse_id ? `ID ${req.preferred_warehouse_id}` : 'Cualquier almacén');
      setValueText(detRoot, 'Preferencia de entrega', prefName);

      const whName =
        req.warehouses?.name ||
        (req.warehouse_id ? `ID ${req.warehouse_id}` : '—');
      setValueText(detRoot, 'Lugar de entrega', whName);

      setValueText(detRoot, 'Fecha límite de entrega', req.due_date || '—');

      // Firmas
      setSignature(detRoot, 'Solicitante', req.requester_sign_result || 'pendiente');
      setSignature(detRoot, 'Tesoro', req.warehouse_sign_result || 'pendiente');

      // Logs (mínimo útil)
      const logs = [];
      if (req.created_at) logs.push(`${toLocale(req.created_at)} · Solicitud creada`);
      if (req.approved_at) logs.push(`${toLocale(req.approved_at)} · Solicitud aprobada`);
      if (req.requester_sign_at) logs.push(`${toLocale(req.requester_sign_at)} · Firma solicitante · ${req.requester_sign_result || 'pendiente'}`);
      if (req.warehouse_sign_at) logs.push(`${toLocale(req.warehouse_sign_at)} · Firma tesoro · ${req.warehouse_sign_result || 'pendiente'}`);
      if (req.completed_at) logs.push(`${toLocale(req.completed_at)} · Solicitud completada`);

      setLogs(detRoot, logs.join('<br>'));
    });
  </script>
</body>
</html>
