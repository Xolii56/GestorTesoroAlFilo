<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Solicitud — Detalle</title>

  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.det-main{
      padding:1.25rem;
      max-width:980px;
      margin:0 auto;
    }
    .det-header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:.75rem;
      flex-wrap:wrap;
      margin-bottom:1rem;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="det-main">
    <div class="det-header-row">
      <div>
        <h2>Detalle de solicitud</h2>
        <p style="opacity:.8;margin-top:.25rem;font-size:.9rem;">
          Información completa de la solicitud.
        </p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.close()">Cerrar</button>
    </div>

    <!-- DET-01 casteado aquí -->
    <div id="cmp-det-01"></div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';
    import { loadComponentById } from './modules/ui_components.js';

    const $ = (sel, root=document) => root.querySelector(sel);
    const slot = (name, root=document) => root.querySelector(`[data-slot="${name}"]`);

    function setText(el, txt){
      if (!el) return;
      el.textContent = (txt === undefined || txt === null || txt === '') ? '—' : String(txt);
    }

    function showError(root, msg){
      const err = slot('det-error', root);
      if (!err) return;
      err.style.display = 'block';
      err.textContent = msg;
    }

    function formatStatus(st) {
      const map = {
        pendiente: 'Pendiente',
        aprobada: 'Aprobada',
        rechazada: 'Rechazada',
        completada: 'Completada',
        cancelada: 'Cancelada'
      };
      return map[st] || st || '—';
    }

    function renderTipo(tipo){
      if (!tipo) return '—';
      return tipo === 'compra' ? 'Compra' : 'Venta';
    }

    function tipoTagClass(tipo){
      return (tipo === 'venta') ? 'tag tag--venta' : 'tag tag--compra';
    }

    function statusTagClass(st){
      return `tag tag--${st}`;
    }

    function toLocale(dt){
      if (!dt) return '—';
      try { return new Date(dt).toLocaleString(); } catch { return String(dt); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 0) Castear DET-01
      await loadComponentById('./components/det-01.html', 'cmp-det-01');
      const detRoot = document.getElementById('cmp-det-01');

      // Botón cerrar dentro del componente
      const closeBtn = slot('det-close', detRoot);
      if (closeBtn) closeBtn.addEventListener('click', () => window.close());

      // 1) Sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = './index.html'; return; }

      // 2) org_status mínimo
      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // 3) Header
      if (typeof window.loadHeader === 'function') await window.loadHeader('app');
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => { await supa.auth.signOut(); window.location.href = "./index.html"; },
          () => { window.location.href = './perfil.html'; }
        );
      }

      // 4) ID desde URL (sol_commodities abre ?id=...)
      const params = new URLSearchParams(window.location.search);
      const rawId = params.get('id');

      if (!rawId) {
        showError(detRoot, 'No se ha proporcionado un ID de solicitud en la URL (?id=...).');
        return;
      }

      const cleanedId = String(rawId).replace(/^#/, '').trim();

      // 5) Cargar solicitud (robusto: id numérico o texto)
      const isNumeric = /^[0-9]+$/.test(cleanedId);
      const idValue = isNumeric ? Number(cleanedId) : cleanedId;

      const { data: req, error: reqError } = await supa
        .from('requests')
        .select(`
          id,
          request_type,
          item_id,
          quantity,
          status,
          created_at,
          due_date,
          approved_at,
          completed_at,
          warehouse_id,
          preferred_warehouse_id,
          requester_discord_id,
          warehouse_sign_result,
          warehouse_sign_at,
          requester_sign_result,
          requester_sign_at,
          commodities_master(name, symbol),
          warehouses:warehouse_id(id, name),
          preferred_wh:preferred_warehouse_id(id, name)
        `)
        .eq('id', idValue)
        .maybeSingle();

      if (reqError) {
        console.error('Detalle solicitud -> error select:', reqError);
        showError(detRoot, 'No se pudo cargar la solicitud (error de base de datos).');
        return;
      }

      if (!req) {
        showError(detRoot, 'No se pudo cargar la solicitud (no existe o no tienes permisos de lectura).');
        return;
      }

      // 6) Nombre solicitante
      let requesterName = req.requester_discord_id || '—';
      if (req.requester_discord_id) {
        const { data: uRow } = await supa
          .from('users')
          .select('handle_name, discord_username')
          .eq('id', req.requester_discord_id)
          .maybeSingle();

        requesterName = uRow?.handle_name || uRow?.discord_username || req.requester_discord_id;
      }

      // 7) Pintar en DET-01
      setText(slot('det-id', detRoot), `#${req.id}`);

      const tipo = req.request_type || null;
      const st = req.status || 'pendiente';

      const tipoTagHost = slot('det-tipo-tag', detRoot);
      if (tipoTagHost) tipoTagHost.innerHTML = `<span class="${tipoTagClass(tipo)}">${renderTipo(tipo)}</span>`;

      const stTagHost = slot('det-estado-tag', detRoot);
      if (stTagHost) stTagHost.innerHTML = `<span class="${statusTagClass(st)}">${formatStatus(st)}</span>`;

      setText(slot('det-solicitante', detRoot), requesterName);
      setText(slot('det-tipo', detRoot), renderTipo(tipo));

      const cm = req.commodities_master;
      const itemName = cm
        ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
        : (req.item_id || '—');

      setText(slot('det-item', detRoot), itemName);
      setText(slot('det-cantidad', detRoot), req.quantity);

      const prefName =
        req.preferred_wh?.name ||
        (req.preferred_warehouse_id ? `ID ${req.preferred_warehouse_id}` : 'Cualquier almacén');

      setText(slot('det-preferido', detRoot), prefName);

      const whName =
        req.warehouses?.name ||
        (req.warehouse_id ? `ID ${req.warehouse_id}` : '—');

      setText(slot('det-almacen', detRoot), whName);

      setText(slot('det-creada', detRoot), toLocale(req.created_at));
      setText(slot('det-plazo', detRoot), req.due_date || '—');

      const ws = req.warehouse_sign_result || 'pendiente';
      const rs = req.requester_sign_result || 'pendiente';

      setText(slot('det-firma-almacen', detRoot),
        `${ws}${req.warehouse_sign_at ? ' · ' + toLocale(req.warehouse_sign_at) : ''}`
      );

      setText(slot('det-firma-solicitante', detRoot),
        `${rs}${req.requester_sign_at ? ' · ' + toLocale(req.requester_sign_at) : ''}`
      );

      const cierre = req.completed_at || req.approved_at || null;
      setText(slot('det-cierre', detRoot), cierre ? toLocale(cierre) : '—');
    });
  </script>
</body>
</html>
