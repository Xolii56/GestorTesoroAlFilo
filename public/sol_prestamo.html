<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Préstamos</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.prestamo-main {
      padding: 1.5rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .sol-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.8rem 1rem;
    }

    @media (max-width: 800px) {
      .sol-form-grid {
        grid-template-columns: 1fr;
      }
    }

    .sol-form .field {
      display: flex;
      flex-direction: column;
    }

    .sol-form label {
      display: block;
      font-size: .8rem;
      opacity: .8;
      margin-bottom: .2rem;
    }

    .sol-form select,
    .sol-form input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.55rem;
      border: 1px solid rgba(148,163,184,0.65);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: .85rem;
    }

    .sol-form input[readonly],
    .sol-form select[disabled] {
      opacity: 0.8;
      cursor: default;
    }

    .loans-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .82rem;
    }

    .loans-table th,
    .loans-table td {
      padding: 0.35rem 0.5rem;
      border-bottom: 1px solid rgba(30,64,175,0.4);
      text-align: left;
      white-space: nowrap;
    }

    .loans-table th {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      opacity: .75;
    }

    .loans-table tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.75);
    }

    .loans-table tbody tr:hover {
      background: rgba(15,23,42,0.95);
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      font-size: .75rem;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .badge-status.pendiente   { border-color: rgba(250,204,21,0.9); }
    .badge-status.aprobada    { border-color: rgba(34,197,94,0.9); }
    .badge-status.rechazada   { border-color: rgba(248,113,113,0.9); }
    .badge-status.completada  { border-color: rgba(56,189,248,0.9); }
    .badge-status.cancelada   { border-color: rgba(248,113,113,0.9); }

    .btn {
      padding: .55rem 1rem;
      border-radius: 12px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #e7eaf3;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .btn-primary {
      border-color: #2563eb;
      background: #1d4ed8;
    }

    .btn-secondary {
      background: transparent;
    }

    .btn:hover {
      filter: brightness(1.08);
    }

    .btn-disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .loans-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
      flex-wrap:wrap;
      margin-bottom:.6rem;
    }

    .loans-toolbar input[type="search"] {
      padding:0.35rem 0.5rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.8rem;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="prestamo-main">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:.75rem;flex-wrap:wrap;">
      <div>
        <h2>Préstamos</h2>
      </div>
      <button type="button"
              class="btn btn-secondary"
              onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <!-- FORMULARIO -->
    <div class="card">
      <h3 style="margin-top:0;">Nuevo préstamo</h3>

      <form id="loan-form" class="sol-form">
        <div class="sol-form-grid">

          <!-- Fila 1 -->
          <div class="field">
            <label>Solicitante</label>
            <input id="loan-solicitante" type="text" readonly />
          </div>

          <div class="field">
            <label for="loan-guarantor">Avalista</label>
            <select id="loan-guarantor" required>
              <option value="">Selecciona...</option>
            </select>
          </div>

          <!-- Fila 2 -->
          <div class="field">
            <label for="loan-amount">Cantidad solicitada</label>
            <select id="loan-amount" required>
              <option value="">Selecciona...</option>
              <option value="1000000">1 M UEC</option>
              <option value="5000000">5 M UEC</option>
              <option value="10000000">10 M UEC</option>
              <option value="20000000">20 M UEC</option>
              <option value="50000000">50 M UEC</option>
            </select>
          </div>

          <div class="field">
            <label for="loan-term">Plazo de devolución</label>
            <select id="loan-term" required>
              <option value="">Selecciona...</option>
              <option value="1">1 semana</option>
              <option value="2">2 semanas</option>
              <option value="3">3 semanas</option>
              <option value="4">4 semanas</option>
            </select>
          </div>

          <!-- Fila 3 -->
          <div class="field">
            <label for="loan-interest">Interés</label>
            <input id="loan-interest" type="text" readonly />
          </div>

          <div class="field">
            <label for="loan-total">Cantidad a devolver</label>
            <input id="loan-total" type="text" readonly />
          </div>

        </div>

        <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.8rem;">
          <button type="submit" class="btn btn-primary" id="loan-submit-btn">
            Solicitar préstamo
          </button>
        </div>
      </form>
    </div>

    <!-- TABLAS -->
    <div class="card" style="margin-top:1.25rem;">
      <h3 style="margin-top:0;">Mis préstamos activos</h3>

      <div class="loans-toolbar">
        <input type="search" id="loan-open-search" placeholder="Buscar por avalista..."/>
      </div>

      <div class="table-container">
        <table class="loans-table">
          <thead>
            <tr>
              <th>ID</th><th>Fecha</th><th>Cantidad</th><th>Plazo</th><th>Interés</th><th>Avalista</th><th>Estado</th>
            </tr>
          </thead>
          <tbody id="loan-open-tbody">
            <tr><td colspan="7">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:1.25rem;">
      <h3 style="margin-top:0;">Histórico de préstamos</h3>

      <div class="loans-toolbar">
        <input type="search" id="loan-history-search" placeholder="Buscar por avalista..."/>
      </div>

      <div class="table-container">
        <table class="loans-table">
          <thead>
            <tr>
              <th>ID</th><th>Fecha</th><th>Cantidad</th><th>Plazo</th><th>Interés</th><th>Avalista</th><th>Estado</th>
            </tr>
          </thead>
          <tbody id="loan-history-tbody">
            <tr><td colspan="7">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

<script type="module">
import { getOrgStatus } from './modules/profile.js';

document.addEventListener('DOMContentLoaded', async () => {
  const { supa } = window;

  function formatAmount(amount) {
    if (!amount) return '-';
    return (amount / 1_000_000) + ' M UEC';
  }

  function formatDate(iso) {
    const d = new Date(iso);
    return d.toLocaleString('es-ES');
  }

  function interestFromWeeks(w) {
    return {1:5,2:10,3:15,4:20}[w] || 0;
  }

  // Sesión
  const { data:{session} } = await supa.auth.getSession();
  if (!session) return location.href = './index.html';

  const orgStatus = await getOrgStatus();
  if (!['miembro','daga','espada','admin'].includes(orgStatus))
    return location.href = './index.html';

  // Header
  if (window.loadHeader) await loadHeader('app');
  if (window.initHeaderUserMenu)
    initHeaderUserMenu(session, async()=>{await supa.auth.signOut();location.href='./index.html';}, ()=>location.href='./perfil.html');

  // Permisos
  const { data: meRow } = await supa.from('users').select('tesoro_internal_role, handle_name, discord_username').eq('id', session.user.id).single();
  const myRole = (meRow?.tesoro_internal_role || '').trim();
  let roleRow = null;

  if (myRole) {
    const { data } = await supa.from('roles_app').select('*').or(`id.eq.${myRole},role_name.ilike.${myRole}`).maybeSingle();
    roleRow = data;
  }

  const solLevel = roleRow?.solicitudes ?? 0;
  if (!solLevel) return location.href = './app_ui.html';

  const readOnly = solLevel === 1;

  // Form
  const solicitanteInput = document.getElementById('loan-solicitante');
  const guarantorSelect = document.getElementById('loan-guarantor');
  const amountSelect = document.getElementById('loan-amount');
  const termSelect = document.getElementById('loan-term');
  const interestInput = document.getElementById('loan-interest');
  const totalInput = document.getElementById('loan-total');
  const loanForm = document.getElementById('loan-form');
  const loanSubmitBtn = document.getElementById('loan-submit-btn');

  solicitanteInput.value =
    meRow?.handle_name ||
    meRow?.discord_username ||
    session.user.email ||
    session.user.id;

  if (readOnly) {
    loanForm.querySelectorAll('input,select').forEach(e=>{
      if(e.id!=='loan-solicitante') e.disabled = true;
    });
    loanSubmitBtn.classList.add('btn-disabled');
  }

  // Cargar avalistas
  const { data: avalistas } = await supa
    .from('users')
    .select('id, handle_name, discord_username, org_status')
    .in('org_status',['daga','espada','admin'])
    .order('handle_name',{ascending:true});

  const guarantorsById = {};
  (avalistas||[]).forEach(u=>{
    const name = u.handle_name || u.discord_username || u.id;
    guarantorsById[u.id] = { name };
    const opt = document.createElement('option');
    opt.value = u.id;
    opt.textContent = name;
    guarantorSelect.appendChild(opt);
  });

  // Cálculo de interés y total
  function updateTotals() {
    const amount = parseInt(amountSelect.value,10) || 0;
    const weeks = parseInt(termSelect.value,10) || 0;
    const interest = interestFromWeeks(weeks);

    interestInput.value = interest ? interest + ' %' : '';

    if (amount && interest) {
      const total = Math.round(amount * (1 + interest/100));
      totalInput.value = formatAmount(total);
      totalInput.dataset.raw = total;
    } else {
      totalInput.value = '';
      totalInput.dataset.raw = '';
    }
  }

  amountSelect.addEventListener('change', updateTotals);
  termSelect.addEventListener('change', updateTotals);

  // Listas de préstamos
  const openTbody = document.getElementById('loan-open-tbody');
  const historyTbody = document.getElementById('loan-history-tbody');
  const searchOpen = document.getElementById('loan-open-search');
  const searchHist = document.getElementById('loan-history-search');

  let allLoans = [];

  async function loadLoans() {
    const { data } = await supa
      .from('loan_requests')
      .select('*')
      .eq('requester_id', session.user.id)
      .order('created_at',{ascending:false});

    allLoans = data || [];
    renderTables();
  }

  function renderTables() {
    const fOpen = (searchOpen.value||'').toLowerCase();
    const fHist = (searchHist.value||'').toLowerCase();

    const active = allLoans.filter(l => ['pendiente','aprobada'].includes(l.status));
    const history = allLoans.filter(l => !['pendiente','aprobada'].includes(l.status));

    // activos
    openTbody.innerHTML = '';
    active
      .filter(l=>{
        const g=guarantorsById[l.guarantor_id]?.name?.toLowerCase()||'';
        return g.includes(fOpen);
      })
      .forEach(l=>{
        const g=guarantorsById[l.guarantor_id]?.name||'-';
        openTbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>#${l.id}</td>
          <td>${formatDate(l.created_at)}</td>
          <td>${formatAmount(l.amount)}</td>
          <td>${l.term_weeks} semanas</td>
          <td>${l.interest_percent} %</td>
          <td>${g}</td>
          <td><span class="badge-status ${l.status}">${l.status}</span></td>
        </tr>`);
      });

    if (!openTbody.children.length)
      openTbody.innerHTML = `<tr><td colspan="7">No tienes préstamos activos.</td></tr>`;

    // histórico
    historyTbody.innerHTML = '';
    history
      .filter(l=>{
        const g=guarantorsById[l.guarantor_id]?.name?.toLowerCase()||'';
        return g.includes(fHist);
      })
      .forEach(l=>{
        const g=guarantorsById[l.guarantor_id]?.name||'-';
        historyTbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>#${l.id}</td>
          <td>${formatDate(l.created_at)}</td>
          <td>${formatAmount(l.amount)}</td>
          <td>${l.term_weeks} semanas</td>
          <td>${l.interest_percent} %</td>
          <td>${g}</td>
          <td><span class="badge-status ${l.status}">${l.status}</span></td>
        </tr>`);
      });

    if (!historyTbody.children.length)
      historyTbody.innerHTML = `<tr><td colspan="7">No hay histórico.</td></tr>`;
  }

  searchOpen.addEventListener('input', renderTables);
  searchHist.addEventListener('input', renderTables);

  await loadLoans();

  // Envío
  loanForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (readOnly) return;

    const amount = parseInt(amountSelect.value,10);
    const weeks = parseInt(termSelect.value,10);
    const guarantor = guarantorSelect.value;

    const interestPercent = interestFromWeeks(weeks);

    const payload = {
      requester_id: session.user.id,
      amount,
      term_weeks: weeks,
      interest_percent: interestPercent,
      guarantor_id: guarantor,
      status: 'pendiente'
    };

    const { error } = await supa
      .from('loan_requests')
      .insert(payload);

    if (error) {
      alert('Error creando préstamo:\n' + error.message);
      return;
    }

    loanForm.reset();
    solicitanteInput.value = solicitanteInput.value;
    interestInput.value = '';
    totalInput.value = '';

    await loadLoans();
    alert('Préstamo solicitado.');
  });

});
</script>

</body>
</html>
