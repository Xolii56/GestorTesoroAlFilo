<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Almacenes</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.ware-main {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .ware-header-line {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
      flex-wrap:wrap;
      margin-bottom:1rem;
    }

    .btn {
      padding:0.35rem 0.9rem;
      border-radius:0.4rem;
      border:none;
      cursor:pointer;
      font-size:.85rem;
    }
    .btn-secondary {
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.8);
    }
    .btn-primary {
      background:#22c55e;
      color:#020617;
      font-weight:600;
    }
    .btn-danger {
      background:#ef4444;
      color:#f9fafb;
      font-weight:600;
    }
    .btn-icon {
      border-radius:999px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      padding:0;
    }

    /* Bloque 1: lista de almacenes */
    .ware-list-card {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }

    .ware-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:.45rem;
      align-items:center;
    }

    .ware-btn {
      padding:0.25rem 0.75rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.85rem;
      cursor:pointer;
      opacity:.85;
      transition:background .12s ease-out, border-color .12s, opacity .12s;
    }

    .ware-btn:hover {
      opacity:1;
      border-color:rgba(56,189,248,0.85);
    }

    .ware-btn.active {
      background:rgba(56,189,248,0.15);
      border-color:rgba(56,189,248,0.95);
      opacity:1;
    }

    .ware-subtitle {
      font-size:.85rem;
      opacity:.8;
      margin-bottom:.35rem;
    }

    /* Bloque 2 */
    #warehouse-panel {
      margin-top:1.3rem;
      display:none; /* oculto hasta que haya almacén seleccionado */
    }

    .ware-meta {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:1rem;
      flex-wrap:wrap;
      margin-bottom:.8rem;
    }

    .ware-meta-left {
      font-size:.85rem;
      opacity:.9;
      line-height:1.3rem;
    }

    .ware-meta-left strong {
      opacity:1;
    }

    .ware-tabs {
      display:flex;
      gap:.5rem;
      border-bottom:1px solid rgba(30,64,175,0.7);
      margin-bottom:.6rem;
    }

    .ware-tab {
      padding:0.3rem 0.8rem;
      border:none;
      cursor:pointer;
      font-size:.85rem;
      background:transparent;
      color:#e5e7eb;
      opacity:.7;
      border-bottom:2px solid transparent;
    }

    .ware-tab.active {
      opacity:1;
      border-bottom-color:#22c55e;
    }

    .ware-section {
      display:none;
    }

    .ware-section.active {
      display:block;
    }

    /* Tabla inventario */
    .ware-table {
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    .ware-table thead {
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.8;
    }
    .ware-table th,
    .ware-table td {
      padding:0.35rem 0.45rem;
      border-bottom:1px solid rgba(148,163,184,0.26);
    }

    .badge-stock {
      display:inline-flex;
      padding:0.08rem 0.45rem;
      border-radius:999px;
      font-size:.75rem;
      border:1px solid rgba(148,163,184,0.8);
    }
    .badge-stock.critico   { border-color:rgba(248,113,113,0.9); }
    .badge-stock.seguro    { border-color:rgba(34,197,94,0.9); }
    .badge-stock.excedente { border-color:rgba(56,189,248,0.9); }

    .help-text {
      font-size:.75rem;
      opacity:.7;
      margin-top:.2rem;
    }

    /* Modal almacén */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal {
      background:#020617;
      border-radius:0.75rem;
      padding:1rem 1.2rem;
      max-width:420px;
      width:100%;
      box-shadow:0 20px 45px rgba(0,0,0,0.8);
    }
    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.6rem;
    }
    .modal-fields .field {
      margin-bottom:.7rem;
    }
    .modal-fields label {
      display:block;
      font-size:.8rem;
      opacity:.8;
      margin-bottom:.2rem;
    }
    .modal-fields input {
      width:100%;
      padding:0.4rem 0.5rem;
      border-radius:0.4rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.9rem;
    }

    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      margin-top:.4rem;
    }

    .hidden {
      display:none !important;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="ware-main">
    <div class="ware-header-line">
      <div>
        <h2>Almacenes</h2>
        <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
          Selecciona un almacén para ver su inventario y las solicitudes asignadas.
        </p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <!-- BLOQUE 1: lista de almacenes -->
    <div class="card">
      <div class="ware-list-card">
        <div>
          <div class="ware-subtitle">Almacenes disponibles</div>
          <div id="warehouse-buttons" class="ware-buttons">
            <!-- Botones de almacén aquí -->
          </div>
        </div>
        <button type="button" id="btn-new-warehouse" class="btn btn-primary btn-icon" title="Añadir almacén">
          +
        </button>
      </div>
      <div id="ware-no-warehouses" class="help-text" style="margin-top:.4rem;display:none;">
        No hay ningún almacén configurado todavía.
      </div>
    </div>

    <!-- BLOQUE 2: contenido del almacén seleccionado -->
    <div id="warehouse-panel" class="card" style="margin-top:1.2rem;">
      <div class="ware-meta">
        <div class="ware-meta-left">
          <div><strong id="meta-name">Almacén</strong></div>
          <div id="meta-system"></div>
          <div id="meta-location"></div>
          <div id="meta-manager"></div>
        </div>
        <div style="display:flex;gap:.5rem;align-items:center;">
          <button type="button" id="btn-edit-warehouse" class="btn btn-secondary">
            Editar almacén
          </button>
        </div>
      </div>

      <div class="ware-tabs">
        <button type="button" class="ware-tab active" data-tab="inventario">Inventario</button>
        <button type="button" class="ware-tab" data-tab="solicitudes">Solicitudes asignadas</button>
      </div>

      <!-- Sección inventario -->
      <div id="section-inventario" class="ware-section active">
        <div style="max-height:420px;overflow:auto;">
          <table class="ware-table">
            <thead>
              <tr>
                <th>Commodity</th>
                <th>Símbolo</th>
                <th>Cant.</th>
                <th>Rango stock</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tbody-inventario"></tbody>
          </table>
        </div>
        <div id="inventario-empty" class="help-text" style="display:none;margin-top:.4rem;">
          Este almacén todavía no tiene inventario registrado.
        </div>
      </div>

      <!-- Sección solicitudes -->
      <div id="section-solicitudes" class="ware-section">
        <div style="max-height:420px;overflow:auto;">
          <table class="ware-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Tipo</th>
                <th>Ítem</th>
                <th>Cant.</th>
                <th>Solicitante</th>
                <th>Estado</th>
                <th>Creada</th>
              </tr>
            </thead>
            <tbody id="tbody-solicitudes"></tbody>
          </table>
        </div>
        <div id="solicitudes-empty" class="help-text" style="display:none;margin-top:.4rem;">
          No hay solicitudes asignadas a este almacén.
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL CREAR / EDITAR ALMACÉN -->
  <div id="warehouse-modal-backdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h3 id="warehouse-modal-title" style="margin:0;font-size:1rem;">Nuevo almacén</h3>
        <button type="button" id="warehouse-modal-close" class="btn btn-secondary btn-icon">×</button>
      </div>
      <div class="modal-fields">
        <div class="field">
          <label>Nombre del almacén</label>
          <input id="wm-name" type="text" />
        </div>
        <div class="field">
          <label>Sistema</label>
          <input id="wm-system" type="text" />
        </div>
        <div class="field">
          <label>Ubicación</label>
          <input id="wm-location" type="text" />
        </div>
        <div class="field">
          <label>Encargado</label>
          <input id="wm-manager" type="text" />
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" id="warehouse-modal-cancel" class="btn btn-secondary">Cancelar</button>
        <button type="button" id="warehouse-modal-save" class="btn btn-primary">Guardar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 1) Sesión + org_status
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = './index.html';
        return;
      }

      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // Header
      await loadHeader('app');
      initHeaderUserMenu(
        session,
        async () => {
          await supa.auth.signOut();
          window.location.href = "./index.html";
        },
        () => window.location.href = './perfil.html'
      );

      // 2) Permisos módulo "almacenes"
      const { data: meRow } = await supa
        .from('users')
        .select('tesoro_internal_role')
        .eq('id', session.user.id)
        .maybeSingle();

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === 'string') myRole = myRole.trim();

      let appRoleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber)) {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .eq('id', asNumber)
            .maybeSingle();
          if (!error) appRoleRow = data;
        }
        if (!appRoleRow) {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .ilike('role_name', myRole)
            .maybeSingle();
          if (!error) appRoleRow = data;
        }
      }

      const almacLevel = appRoleRow?.almacenes ?? 0;
      if (!almacLevel || almacLevel === 0) {
        alert('No tienes acceso al módulo de Almacenes.');
        window.location.href = './app_ui.html';
        return;
      }
      const readOnly = (almacLevel === 1);

      // 3) Referencias DOM
      const btnNewWarehouse = document.getElementById('btn-new-warehouse');
      const wareButtonsWrap = document.getElementById('warehouse-buttons');
      const noWareMsg       = document.getElementById('ware-no-warehouses');

      const panel        = document.getElementById('warehouse-panel');
      const metaName     = document.getElementById('meta-name');
      const metaSystem   = document.getElementById('meta-system');
      const metaLocation = document.getElementById('meta-location');
      const metaManager  = document.getElementById('meta-manager');

      const tabButtons   = document.querySelectorAll('.ware-tab');
      const sectionInv   = document.getElementById('section-inventario');
      const sectionSol   = document.getElementById('section-solicitudes');

      const tbodyInv     = document.getElementById('tbody-inventario');
      const tbodySol     = document.getElementById('tbody-solicitudes');
      const invEmpty     = document.getElementById('inventario-empty');
      const solEmpty     = document.getElementById('solicitudes-empty');

      const btnEditWarehouse = document.getElementById('btn-edit-warehouse');

      // Modal refs
      const modalBackdrop  = document.getElementById('warehouse-modal-backdrop');
      const modalTitle     = document.getElementById('warehouse-modal-title');
      const wmName         = document.getElementById('wm-name');
      const wmSystem       = document.getElementById('wm-system');
      const wmLocation     = document.getElementById('wm-location');
      const wmManager      = document.getElementById('wm-manager');
      const modalBtnClose  = document.getElementById('warehouse-modal-close');
      const modalBtnCancel = document.getElementById('warehouse-modal-cancel');
      const modalBtnSave   = document.getElementById('warehouse-modal-save');

      if (readOnly) {
        btnNewWarehouse.classList.add('btn-disabled');
        btnNewWarehouse.disabled = true;
        btnEditWarehouse.classList.add('btn-disabled');
        btnEditWarehouse.disabled = true;
      }

      let allWarehouses = [];
      let selectedWarehouse = null; // objeto almacén actual
      let modalMode = 'new'; // 'new' | 'edit'

      // 4) Cargar almacenes (AQUÍ estaba el problema, ahora es un select directo a public.warehouses)
      async function loadWarehouses() {
        const { data, error } = await supa
          .from('warehouses')      // ← asegúrate de que la tabla se llama así
          .select('*');            // sin filtros raros ni order que pueda petar

        if (error) {
          console.error('Error cargando almacenes:', error);
          alert('No se han podido cargar los almacenes.\n\n' + error.message);
          allWarehouses = [];
        } else {
          allWarehouses = data || [];
        }

        renderWarehouseButtons();
      }

      function renderWarehouseButtons() {
        wareButtonsWrap.innerHTML = '';

        if (!allWarehouses.length) {
          noWareMsg.style.display = 'block';
          panel.style.display = 'none';
          return;
        }
        noWareMsg.style.display = 'none';

        allWarehouses.forEach(w => {
          const btn = document.createElement('button');
          btn.className = 'ware-btn';
          btn.textContent = w.name || w.warehouse_name || 'Almacén';
          btn.dataset.id = w.id;

          if (selectedWarehouse && selectedWarehouse.id === w.id) {
            btn.classList.add('active');
          }

          btn.addEventListener('click', () => {
            // toggle único
            if (!selectedWarehouse || selectedWarehouse.id !== w.id) {
              selectedWarehouse = w;
              [...wareButtonsWrap.querySelectorAll('.ware-btn')]
                .forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              showWarehousePanel();
            }
          });

          wareButtonsWrap.appendChild(btn);
        });
      }

      function showWarehousePanel() {
        if (!selectedWarehouse) {
          panel.style.display = 'none';
          return;
        }

        panel.style.display = 'block';

        const w = selectedWarehouse;
        const name = w.name || w.warehouse_name || 'Almacén';
        const system = w.system || w.system_name || '';
        const loc = w.location || w.place || '';
        const manager = w.manager_handle || w.encargado || '';

        metaName.textContent = name;
        metaSystem.textContent   = system ? `Sistema: ${system}` : '';
        metaLocation.textContent = loc    ? `Ubicación: ${loc}`  : '';
        metaManager.textContent  = manager? `Encargado: ${manager}` : '';

        // Por defecto pestaña inventario
        setActiveTab('inventario');

        loadInventarioForWarehouse(w.id);
        loadSolicitudesForWarehouse(w.id);
      }

      function setActiveTab(tab) {
        tabButtons.forEach(btn => {
          const t = btn.dataset.tab;
          btn.classList.toggle('active', t === tab);
        });
        sectionInv.classList.toggle('active', tab === 'inventario');
        sectionSol.classList.toggle('active', tab === 'solicitudes');
      }

      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          setActiveTab(btn.dataset.tab);
        });
      });

      // 5) Inventario del almacén
      function computeStockStatus(qty, min, max) {
        if (min == null || max == null) return { label: 'N/D', cls: '' };
        if (qty < min)  return { label: 'Crítico',   cls: 'critico' };
        if (qty > max)  return { label: 'Excedente', cls: 'excedente' };
        return { label: 'Seguro', cls: 'seguro' };
      }

      async function loadInventarioForWarehouse(warehouseId) {
        tbodyInv.innerHTML = '';
        invEmpty.style.display = 'none';

        // Ajusta nombres de tabla / columnas si los tuyos son otros
        const { data, error } = await supa
          .from('warehouse_stock') // tabla de stock por almacén que montamos en su día
          .select(`
            quantity,
            commodity_id,
            commodities_master (
              name,
              symbol,
              stock_min,
              stock_max
            )
          `)
          .eq('warehouse_id', warehouseId);

        if (error) {
          console.error('Error cargando inventario:', error);
          invEmpty.textContent = 'No se ha podido cargar el inventario de este almacén.';
          invEmpty.style.display = 'block';
          return;
        }

        const rows = data || [];
        if (!rows.length) {
          invEmpty.textContent = 'Este almacén todavía no tiene inventario registrado.';
          invEmpty.style.display = 'block';
          return;
        }

        rows.forEach(r => {
          const cm = r.commodities_master;
          const name = cm?.name || '';
          const symbol = cm?.symbol || '';
          const qty = r.quantity ?? 0;
          const min = cm?.stock_min ?? null;
          const max = cm?.stock_max ?? null;

          const st = computeStockStatus(qty, min, max);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name}</td>
            <td>${symbol}</td>
            <td>${qty}</td>
            <td>${(min ?? '-') + ' - ' + (max ?? '-')}</td>
            <td><span class="badge-stock ${st.cls}">${st.label}</span></td>
          `;
          tbodyInv.appendChild(tr);
        });
      }

      // 6) Solicitudes asignadas al almacén
      async function loadSolicitudesForWarehouse(warehouseId) {
        tbodySol.innerHTML = '';
        solEmpty.style.display = 'none';

        const { data, error } = await supa
          .from('requests')
          .select(`
            id,
            request_type,
            quantity,
            status,
            created_at,
            requester_handle,
            commodities_master ( name, symbol )
          `)
          .eq('warehouse_id', warehouseId)
          .in('status', ['aprobada','completada'])
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error cargando solicitudes de almacén:', error);
          solEmpty.textContent = 'No se ha podido cargar las solicitudes de este almacén.';
          solEmpty.style.display = 'block';
          return;
        }

        const rows = (data || []);
        if (!rows.length) {
          solEmpty.textContent = 'No hay solicitudes asignadas a este almacén.';
          solEmpty.style.display = 'block';
          return;
        }

        rows.forEach(r => {
          const cm = r.commodities_master;
          const itemName = cm
            ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
            : '';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>#${r.id}</td>
            <td>${r.request_type === 'compra' ? 'Compra' : 'Venta'}</td>
            <td>${itemName}</td>
            <td>${r.quantity}</td>
            <td>${r.requester_handle || ''}</td>
            <td>${r.status}</td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</td>
          `;
          tbodySol.appendChild(tr);
        });
      }

      // 7) Modal crear / editar almacén
      function openWarehouseModal(mode) {
        modalMode = mode;
        if (mode === 'new') {
          modalTitle.textContent = 'Nuevo almacén';
          wmName.value = '';
          wmSystem.value = '';
          wmLocation.value = '';
          wmManager.value = '';
        } else if (mode === 'edit' && selectedWarehouse) {
          modalTitle.textContent = 'Editar almacén';
          wmName.value     = selectedWarehouse.name || selectedWarehouse.warehouse_name || '';
          wmSystem.value   = selectedWarehouse.system || selectedWarehouse.system_name || '';
          wmLocation.value = selectedWarehouse.location || selectedWarehouse.place || '';
          wmManager.value  = selectedWarehouse.manager_handle || selectedWarehouse.encargado || '';
        }
        modalBackdrop.classList.remove('hidden');
      }

      function closeWarehouseModal() {
        modalBackdrop.classList.add('hidden');
      }

      if (!readOnly) {
        btnNewWarehouse.addEventListener('click', () => openWarehouseModal('new'));
        btnEditWarehouse.addEventListener('click', () => {
          if (!selectedWarehouse) {
            alert('Selecciona un almacén primero.');
            return;
          }
          openWarehouseModal('edit');
        });
      }

      [modalBtnClose, modalBtnCancel].forEach(btn => {
        btn.addEventListener('click', closeWarehouseModal);
      });

      modalBtnSave.addEventListener('click', async () => {
        if (readOnly) return;

        const name = wmName.value.trim();
        const system = wmSystem.value.trim();
        const location = wmLocation.value.trim();
        const manager = wmManager.value.trim();

        if (!name) {
          alert('El almacén necesita un nombre.');
          return;
        }

        if (modalMode === 'new') {
          const { error } = await supa
            .from('warehouses')
            .insert({
              name,
              system,
              location,
              manager_handle: manager
            });
          if (error) {
            console.error('Error creando almacén:', error);
            alert('No se ha podido crear el almacén.\n\n' + error.message);
            return;
          }
        } else if (modalMode === 'edit' && selectedWarehouse) {
          const { error } = await supa
            .from('warehouses')
            .update({
              name,
              system,
              location,
              manager_handle: manager
            })
            .eq('id', selectedWarehouse.id);
          if (error) {
            console.error('Error actualizando almacén:', error);
            alert('No se ha podido actualizar el almacén.\n\n' + error.message);
            return;
          }
        }

        closeWarehouseModal();
        await loadWarehouses();

        // si estábamos editando, re-seleccionamos el almacén actualizado
        if (modalMode === 'edit') {
          const again = allWarehouses.find(w => w.name === name);
          if (again) {
            selectedWarehouse = again;
            showWarehousePanel();
            // marcar botón activo
            [...wareButtonsWrap.querySelectorAll('.ware-btn')].forEach(btn => {
              btn.classList.toggle('active', btn.dataset.id === again.id);
            });
          }
        }
      });

      // 8) Arranque
      await loadWarehouses();
    });
  </script>
</body>
</html>
