<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Registro</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.reg-main {
      padding: 1.5rem;
      max-width: 1300px;
      margin: 0 auto;
    }

    .reg-toolbar {
      display:flex;
      justify-content:space-between;
      gap:.75rem;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:.8rem;
    }

    .reg-toolbar select,
    .reg-toolbar input[type="search"] {
      padding:0.35rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.85rem;
    }

    .reg-table {
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }

    .reg-table thead {
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.8;
    }

    .reg-table th,
    .reg-table td {
      padding:0.4rem 0.45rem;
      border-bottom:1px solid rgba(148,163,184,0.25);
    }

    .reg-table tbody tr {
      transition:background .12s ease-out;
    }

    .reg-table tbody tr:hover {
      background:rgba(15,23,42,0.85);
    }

    /* Centrado columnas específicas */
    .reg-table th:nth-child(2),
    .reg-table td:nth-child(2), /* Tipo */
    .reg-table th:nth-child(4),
    .reg-table td:nth-child(4), /* Cant */
    .reg-table th:nth-child(5),
    .reg-table td:nth-child(5), /* Solicitante */
    .reg-table th:nth-child(6),
    .reg-table td:nth-child(6), /* Estado */
    .reg-table th:nth-child(7),
    .reg-table td:nth-child(7), /* Cerrada */
    .reg-table th:nth-child(8),
    .reg-table td:nth-child(8)  /* Detalle */
    {
      text-align:center;
    }

    .tipo-chip {
      display:inline-block;
      padding:0.08rem 0.45rem;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(148,163,184,0.9);
      opacity:.85;
    }
    .tipo-chip.compra { border-color: rgba(34,197,94,0.9); }
    .tipo-chip.venta  { border-color: rgba(248,113,113,0.9); }

    .badge-status {
      display:inline-flex;
      align-items:center;
      padding:0.1rem 0.55rem;
      border-radius:999px;
      font-size:.75rem;
      border:1px solid rgba(148,163,184,0.7);
    }
    .badge-status.pendiente   { border-color:rgba(250,204,21,0.9); }
    .badge-status.aprobada    { border-color:rgba(34,197,94,0.9); }
    .badge-status.rechazada   { border-color:rgba(248,113,113,0.9); }
    .badge-status.completada  { border-color:rgba(56,189,248,0.9); }
    .badge-status.cancelada   { border-color:rgba(248,113,113,0.9); }
  </style>
</head>

<body>
<div id="site-header"></div>

<main class="reg-main">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:.75rem;flex-wrap:wrap;">
    <div>
      <h2>Registro de solicitudes</h2>
      <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
        Historial completo de todas las solicitudes del Tesoro.
      </p>
    </div>
    <button type="button" class="btn btn-secondary" onclick="window.location.href='./app_ui.html'">
      ← Volver al panel
    </button>
  </div>

  <div class="card" style="padding:1rem 1.2rem;">
    <div class="reg-toolbar">
      <div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;">
        <select id="filtro-estado">
          <option value="todas">Todas</option>
          <option value="pendiente">Pendientes</option>
          <option value="aprobada">Aprobadas</option>
          <option value="rechazada">Rechazadas</option>
          <option value="completada">Completadas</option>
          <option value="cancelada">Canceladas</option>
        </select>

        <input type="search" id="buscador" placeholder="Buscar por ítem o usuario...">
      </div>

      <span class="help-text" id="reg-debug" style="font-style:italic;"></span>
    </div>

    <div style="max-height:520px;overflow:auto;">
      <table class="reg-table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Tipo</th>
          <th>Ítem</th>
          <th>Cant.</th>
          <th>Solicitante</th>
          <th>Estado</th>
          <th>Cerrada</th>
          <th>Detalle</th>
        </tr>
        </thead>
        <tbody id="reg-tbody"></tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
  import { getOrgStatus } from "./modules/profile.js";

  document.addEventListener("DOMContentLoaded", async () => {
    const { supa } = window;

    function formatStatus(st) {
      return {
        pendiente: "pendiente",
        aprobada: "aprobada",
        rechazada: "rechazada",
        completada: "completada",
        cancelada: "cancelada"
      }[st] || st;
    }

    function renderTipo(tipo) {
      return tipo === "venta" ? "Venta" : "Compra";
    }

    // ------------------- SESIÓN -------------------
    const { data: { session } } = await supa.auth.getSession();
    if (!session) return (window.location.href = "./index.html");

    const orgStatus = await getOrgStatus();
    if (!orgStatus || !["miembro","daga","espada","admin"].includes(orgStatus)) {
      await supa.auth.signOut();
      return (window.location.href = "./index.html");
    }

    await loadHeader("app");
    initHeaderUserMenu(
      session,
      async () => {
        await supa.auth.signOut();
        window.location.href = "./index.html";
      },
      () => window.location.href = "./perfil.html"
    );

    // ------------------- PERMISOS -------------------
    const { data: meRow } = await supa
      .from("users")
      .select("tesoro_internal_role")
      .eq("id", session.user.id)
      .maybeSingle();

    let myRole = meRow?.tesoro_internal_role;
    if (typeof myRole === "string") myRole = myRole.trim();

    let roleRow = null;
    if (!isNaN(Number(myRole))) {
      const { data } = await supa.from("roles_app").select("*").eq("id", Number(myRole)).maybeSingle();
      roleRow = data;
    }
    if (!roleRow && myRole) {
      const { data } = await supa.from("roles_app").select("*").ilike("role_name", myRole).maybeSingle();
      roleRow = data;
    }

    if (!roleRow?.registro) {
      alert("No tienes acceso al módulo de Registro.");
      return (window.location.href = "./app_ui.html");
    }

    // ------------------- USUARIOS -------------------
    const { data: users } = await supa
      .from("users")
      .select("id, handle_name, discord_username, discord_user_id");

    const usersById = {};
    const usersByDiscord = {};
    (users || []).forEach(u => {
      usersById[u.id] = u;
      if (u.discord_user_id) usersByDiscord[String(u.discord_user_id)] = u;
    });

    function resolveUser(id) {
      const idStr = id ? String(id) : "";
      const u = usersByDiscord[idStr] || usersById[idStr];
      return u?.handle_name || u?.discord_username || idStr || "-";
    }

    // ------------------- WAREHOUSES -------------------
    const { data: warehouses } = await supa.from("warehouses").select("id,name");
    const warehousesById = {};
    (warehouses || []).forEach(w => warehousesById[w.id] = w);

    // ------------------- DOM -------------------
    const tbody = document.getElementById("reg-tbody");
    const filtro = document.getElementById("filtro-estado");
    const buscador = document.getElementById("buscador");

    let allRequests = [];

    // ------------------- LOAD REQUESTS -------------------
    async function loadRequests() {
      const { data } = await supa
        .from("requests")
        .select(`
          id,
          request_type,
          item_id,
          quantity,
          status,
          created_at,
          requester_discord_id,
          warehouse_id,
          due_date,
          approved_at,
          completed_at,
          requester_sign_at,
          warehouse_sign_at,
          commodities_master(name,symbol)
        `)
        .order("created_at", { ascending: false });

      allRequests = data || [];
      renderTable();
    }

    function calcFechaCerrada(r) {
      const st = r.status;

      if (st === "completada") return r.completed_at || r.requester_sign_at || r.warehouse_sign_at;
      if (st === "cancelada") return r.requester_sign_at || r.warehouse_sign_at;
      if (st === "rechazada") return r.approved_at || r.created_at;

      return null;
    }

    function renderTable() {
      tbody.innerHTML = "";

      const est = filtro.value;
      const term = (buscador.value || "").toLowerCase();

      allRequests.forEach(r => {
        if (est !== "todas" && r.status !== est) return;

        const cm = r.commodities_master;
        const itemName = cm ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name) : r.item_id;

        const requester = resolveUser(r.requester_discord_id);

        if (term) {
          const searchable = `${itemName} ${requester}`.toLowerCase();
          if (!searchable.includes(term)) return;
        }

        const tr = document.createElement("tr");

        const fechaCierre = calcFechaCerrada(r);

        tr.innerHTML = `
          <td>#${r.id}</td>
          <td><span class="tipo-chip ${r.request_type}">${renderTipo(r.request_type)}</span></td>
          <td>${itemName}</td>
          <td>${r.quantity}</td>
          <td>${requester}</td>
          <td><span class="badge-status ${r.status}">${formatStatus(r.status)}</span></td>
          <td>${fechaCierre ? new Date(fechaCierre).toLocaleString() : "-"}</td>
          <td>
            <button class="btn btn-secondary" style="padding:0.2rem 0.6rem;"
              onclick="window.open('./solicitud_detalle.html?id=${encodeURIComponent(r.id)}','_blank','width=720,height=760')">
              Ver
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    filtro.addEventListener("change", renderTable);
    buscador.addEventListener("input", renderTable);

    await loadRequests();
  });
</script>

</body>
</html>
