<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Registro</title>

  <!-- Estilos globales + design system -->
  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.reg-main{
      padding:1.5rem;
      max-width:1100px;
      margin:0 auto;
    }

    .reg-header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:1rem;
      gap:.75rem;
      flex-wrap:wrap;
    }

    .reg-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      margin-bottom:.6rem;
    }
    .reg-toolbar-group{
      display:flex;
      gap:.45rem;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Buscador / selects con look del sistema */
    .reg-toolbar input[type="search"],
    .reg-toolbar select{
      padding:0.35rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.8rem;
      font-family:inherit;
      outline:none;
    }

    /* Hosts datepicker */
    .reg-date-host{
      display:flex;
      align-items:center;
    }
    .reg-date-host .date-picker{
      width: 210px;
    }
    @media (max-width: 520px){
      .reg-date-host .date-picker{
        width: 100%;
      }
    }

    /* Ajuste centrados por si TAB-07 no lo hace */
    .reg-table-center th:nth-child(2),
    .reg-table-center td:nth-child(2),
    .reg-table-center th:nth-child(3),
    .reg-table-center td:nth-child(3),
    .reg-table-center th:nth-child(5),
    .reg-table-center td:nth-child(5),
    .reg-table-center th:nth-child(6),
    .reg-table-center td:nth-child(6),
    .reg-table-center th:nth-child(7),
    .reg-table-center td:nth-child(7),
    .reg-table-center th:nth-child(8),
    .reg-table-center td:nth-child(8){
      text-align:center;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="reg-main">
    <div class="reg-header-row">
      <div>
        <h2>Registro</h2>
        <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
          Histórico de operaciones y solicitudes del sistema.
        </p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Operaciones registradas</h3>
      </div>

      <div class="reg-toolbar">
        <div class="reg-toolbar-group">
          <input type="search" id="buscador" placeholder="Buscar por solicitante o material..."/>
        </div>

        <div class="reg-toolbar-group">
          <select id="filtro-estado">
            <option value="todas">Todos los estados</option>
            <option value="pendiente">Pendiente</option>
            <option value="aprobada">Aprobada</option>
            <option value="rechazada">Rechazada</option>
            <option value="cancelada">Cancelada</option>
            <option value="completada">Completada</option>
          </select>

          <select id="filtro-tipo">
            <option value="todas">Todos los tipos</option>
            <option value="compra">Compra</option>
            <option value="venta">Venta</option>
          </select>

          <select id="filtro-activo">
            <option value="todas">Todos los activos</option>
            <option value="commodities">Commodities</option>
            <option value="prestamo">Préstamo</option>
            <option value="taller">Taller</option>
            <option value="armeria">Armería</option>
          </select>

          <!-- Date pickers (DAT-01) -->
          <div id="date-from-host" class="reg-date-host" title="Desde"></div>
          <div id="date-to-host" class="reg-date-host" title="Hasta"></div>

          <button type="button" class="btn btn-secondary btn-sm" id="btn-clear-filters">
            Limpiar filtros
          </button>
        </div>
      </div>

      <div style="max-height:560px;overflow:auto;margin-top:.2rem;">
        <div class="table-container" id="cmp-tab-07"></div>
      </div>
    </div>
  </main>

  <!-- CAST: TAB-07 + DAT-01 x2 -->
  <script type="module">
    import { loadComponentById } from './modules/ui_components.js';

    function ensureTbodyId(containerId, wantedId){
      const host = document.getElementById(containerId);
      if (!host) return;

      const direct = host.querySelector(`#${CSS.escape(wantedId)}`);
      if (direct) return;

      const slot = host.querySelector('[data-slot="tbody"]');
      if (slot) { slot.id = wantedId; return; }

      const tb = host.querySelector('tbody');
      if (tb) tb.id = wantedId;
    }

    await loadComponentById('./components/tab-07.html', 'cmp-tab-07');
    ensureTbodyId('cmp-tab-07', 'reg-tbody');

    const host = document.getElementById('cmp-tab-07');
    const table = host?.querySelector('table');
    if (table) table.classList.add('reg-table-center');

    await loadComponentById('./components/dat-01.html', 'date-from-host');
    await loadComponentById('./components/dat-01.html', 'date-to-host');

    // Etiquetas visuales distintas en placeholders (si existen)
    const fromInput = document.querySelector('#date-from-host .date-input');
    const toInput   = document.querySelector('#date-to-host .date-input');
    if (fromInput) fromInput.placeholder = 'Desde...';
    if (toInput)   toInput.placeholder   = 'Hasta...';
  </script>

  <!-- LÓGICA -->
  <script type="module">
    import { getOrgStatus } from "./modules/profile.js";

    document.addEventListener("DOMContentLoaded", async () => {
      const { supa } = window;

      function formatStatus(st) {
        const map = {
          pendiente: "Pendiente",
          aprobada: "Aprobada",
          rechazada: "Rechazada",
          cancelada: "Cancelada",
          completada: "Completada",
        };
        return map[st] || st;
      }

      function renderTipo(tipo) {
        if (!tipo) return "-";
        return tipo === "compra" ? "Compra" : "Venta";
      }

      /* ✅ TAGs del sistema */
      function statusTagClass(st){ return `tag tag--${st}`; }
      function tipoTagClass(tipo){ return (tipo === "venta") ? "tag tag--venta" : "tag tag--compra"; }

      // Activo (por ahora: requests -> commodities)
      function activoTagClass(activoKey){
        if (!activoKey) return "tag tag--info";
        return `tag tag--${activoKey}`;
      }
      function renderActivoLabel(key){
        const map = {
          commodities: "Commodities",
          prestamo: "Préstamo",
          taller: "Taller",
          armeria: "Armería",
        };
        return map[key] || "Commodities";
      }

      /* ───────────── 1) Sesión + org_status ───────────── */
      const { data: { session } } = await supa.auth.getSession();
      if (!session) return (window.location.href = "./index.html");

      const orgStatus = await getOrgStatus();
      if (!orgStatus || !["miembro","daga","espada","admin"].includes(orgStatus)) {
        await supa.auth.signOut();
        return (window.location.href = "./index.html");
      }

      if (typeof window.loadHeader === "function") {
        await window.loadHeader("app");
      }
      if (typeof window.initHeaderUserMenu === "function") {
        window.initHeaderUserMenu(
          session,
          async () => {
            await supa.auth.signOut();
            window.location.href = "./index.html";
          },
          () => window.location.href = "./perfil.html"
        );
      }

      /* ───────────── 2) Permisos ───────────── */
      const { data: meRow } = await supa
        .from("users")
        .select("tesoro_internal_role")
        .eq("id", session.user.id)
        .maybeSingle();

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === "string") myRole = myRole.trim();

      let roleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber) && myRole !== "") {
          const { data } = await supa.from("roles_app").select("*").eq("id", asNumber).maybeSingle();
          roleRow = data || null;
        }
        if (!roleRow) {
          const { data } = await supa.from("roles_app").select("*").ilike("role_name", myRole).maybeSingle();
          roleRow = data || null;
        }
      }

      if (!roleRow?.registro) {
        alert("No tienes acceso al módulo de Registro.");
        return (window.location.href = "./app_ui.html");
      }

      /* ───────────── 3) Usuarios ───────────── */
      const { data: users } = await supa
        .from("users")
        .select("id, handle_name, discord_username, discord_user_id");

      const usersById = {};
      const usersByDiscord = {};
      (users || []).forEach(u => {
        usersById[u.id] = u;
        if (u.discord_user_id) usersByDiscord[String(u.discord_user_id)] = u;
      });

      function resolveUser(id) {
        const idStr = id ? String(id) : "";
        const u = usersByDiscord[idStr] || usersById[idStr];
        return u?.handle_name || u?.discord_username || idStr || "-";
      }

      /* ───────────── 4) Datepicker DAT-01 (misma implementación que usas en revisión) ───────────── */
      function initDat01(pickerRoot, opts = {}) {
        if (!pickerRoot) return null;

        const input = pickerRoot.querySelector('.date-input');
        const popover = pickerRoot.querySelector('.date-popover');
        const monthLabel = pickerRoot.querySelector('.date-month');
        const grid = pickerRoot.querySelector('.date-grid');
        const navs = pickerRoot.querySelectorAll('.date-nav');
        const btnClear = pickerRoot.querySelector('.date-clear');
        const btnToday = pickerRoot.querySelector('.date-today');
        const btnPlus = pickerRoot.querySelectorAll('.date-plus');

        const locale = pickerRoot.dataset.locale || 'es-ES';
        const monthNames = new Intl.DateTimeFormat(locale, { month: 'long' });

        const pad2 = (n) => String(n).padStart(2, '0');
        const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        const formatDisplay = (iso) => {
          if (!iso) return '';
          const [y,m,d] = iso.split('-').map(Number);
          const dt = new Date(y, m-1, d);
          return new Intl.DateTimeFormat(locale, { year:'numeric', month:'2-digit', day:'2-digit' }).format(dt);
        };

        const minToday = !!opts.minToday;

        function buildCalendar(target, year, month, selectedISO) {
          target.innerHTML = '';
          const first = new Date(year, month, 1);
          const last  = new Date(year, month + 1, 0);
          const firstWeekday = (first.getDay() + 6) % 7;
          const daysInMonth = last.getDate();

          const prevLast = new Date(year, month, 0).getDate();
          for (let i = 0; i < firstWeekday; i++) {
            const day = prevLast - (firstWeekday - 1 - i);
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day muted';
            el.textContent = day;
            target.appendChild(el);
          }

          const todayISO = toISO(new Date());

          for (let d = 1; d <= daysInMonth; d++) {
            const iso = `${year}-${pad2(month+1)}-${pad2(d)}`;
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day';
            el.dataset.iso = iso;
            el.textContent = d;

            if (iso === selectedISO) el.classList.add('selected');
            if (iso === todayISO) el.classList.add('today');

            if (minToday && iso < todayISO) {
              el.classList.add('muted');
              el.disabled = true;
            }
            target.appendChild(el);
          }

          const total = firstWeekday + daysInMonth;
          const remain = (7 - (total % 7)) % 7;
          for (let i = 1; i <= remain; i++) {
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day muted';
            el.textContent = i;
            target.appendChild(el);
          }
        }

        function decidePopoverDirection() {
          const rect = pickerRoot.getBoundingClientRect();
          const viewportH = window.innerHeight || document.documentElement.clientHeight;

          const wasHidden = !pickerRoot.classList.contains('open');
          if (wasHidden) {
            pickerRoot.classList.add('open');
            popover.setAttribute('aria-hidden', 'false');
          }

          const popH = popover.getBoundingClientRect().height;

          if (wasHidden) {
            pickerRoot.classList.remove('open');
            popover.setAttribute('aria-hidden', 'true');
          }

          const spaceBelow = viewportH - rect.bottom;
          const spaceAbove = rect.top;

          const needsUp = spaceBelow < (popH + 12) && spaceAbove > spaceBelow;
          pickerRoot.classList.toggle('open-up', needsUp);
        }

        let view = new Date();
        view.setDate(1);

        let selectedISO = '';

        function render() {
          const y = view.getFullYear();
          const m = view.getMonth();
          const monthText = monthNames.format(new Date(y, m, 1));
          monthLabel.textContent = `${monthText.charAt(0).toUpperCase()}${monthText.slice(1)} ${y}`;
          buildCalendar(grid, y, m, selectedISO);
        }

        function open() { decidePopoverDirection(); pickerRoot.classList.add('open'); popover.setAttribute('aria-hidden','false'); }
        function close(){ pickerRoot.classList.remove('open'); popover.setAttribute('aria-hidden','true'); }
        function toggle(){ pickerRoot.classList.contains('open') ? close() : open(); }

        function setISO(iso) {
          selectedISO = iso || '';
          input.value = formatDisplay(selectedISO);
          if (selectedISO) {
            const [y,m] = selectedISO.split('-');
            view = new Date(Number(y), Number(m)-1, 1);
          }
          render();
          close();
          if (typeof opts.onChange === 'function') opts.onChange(selectedISO);
        }

        input.addEventListener('click', toggle);

        navs.forEach(btn => {
          btn.addEventListener('click', () => {
            const dir = Number(btn.dataset.dir || 0);
            view.setMonth(view.getMonth() + dir);
            view.setDate(1);
            render();
            if (pickerRoot.classList.contains('open')) decidePopoverDirection();
          });
        });

        grid.addEventListener('click', (e) => {
          const t = e.target;
          if (!t.classList.contains('date-day')) return;
          if (t.classList.contains('muted')) return;
          const iso = t.dataset.iso;
          if (!iso) return;
          setISO(iso);
        });

        btnClear?.addEventListener('click', () => setISO(''));
        btnToday?.addEventListener('click', () => setISO(toISO(new Date())));
        btnPlus?.forEach(b => {
          b.addEventListener('click', () => {
            const days = Number(b.dataset.days || 0);
            const now = new Date();
            now.setDate(now.getDate() + days);
            setISO(toISO(now));
          });
        });

        window.addEventListener('resize', () => { if (pickerRoot.classList.contains('open')) decidePopoverDirection(); });
        window.addEventListener('scroll', () => { if (pickerRoot.classList.contains('open')) decidePopoverDirection(); }, { passive:true });
        document.addEventListener('click', (e) => { if (!pickerRoot.contains(e.target)) close(); });

        render();

        return { setISO, getISO: () => selectedISO };
      }

      /* ───────────── 5) DOM filtros ───────────── */
      const tbody = document.getElementById("reg-tbody");

      const filtroEstado = document.getElementById("filtro-estado");
      const filtroTipo   = document.getElementById("filtro-tipo");
      const filtroActivo = document.getElementById("filtro-activo");
      const buscador     = document.getElementById("buscador");
      const btnClear     = document.getElementById("btn-clear-filters");

      // date pickers
      const fromRoot = document.querySelector('#date-from-host .date-picker');
      const toRoot   = document.querySelector('#date-to-host .date-picker');

      let isoFrom = ""; // YYYY-MM-DD
      let isoTo   = ""; // YYYY-MM-DD

      const dpFrom = initDat01(fromRoot, {
        minToday: false,
        onChange: (iso) => { isoFrom = iso || ""; renderTable(); }
      });

      const dpTo = initDat01(toRoot, {
        minToday: false,
        onChange: (iso) => { isoTo = iso || ""; renderTable(); }
      });

      let allRequests = [];

      /* ───────────── 6) Load data (requests = commodities) ───────────── */
      async function loadRequests() {
        const { data, error } = await supa
          .from("requests")
          .select(`
            id,
            request_type,
            item_id,
            status,
            created_at,
            requester_discord_id,
            approved_at,
            completed_at,
            requester_sign_at,
            warehouse_sign_at,
            commodities_master(name,symbol)
          `)
          .order("created_at", { ascending: false });

        if (error) {
          console.error("Error cargando registro:", error);
          tbody.innerHTML = `<tr><td colspan="8">No se ha podido cargar el registro.</td></tr>`;
          return;
        }

        allRequests = data || [];
        renderTable();
      }

      function calcFechaCerrada(r) {
        const st = r.status;

        if (st === "completada") return r.completed_at || r.requester_sign_at || r.warehouse_sign_at;
        if (st === "cancelada") return r.requester_sign_at || r.warehouse_sign_at;
        if (st === "rechazada") return r.approved_at || r.created_at;

        return null;
      }

      function isoFromDateTime(dtStr){
        if (!dtStr) return "";
        // created_at viene ISO -> YYYY-MM-DD
        return String(dtStr).slice(0,10);
      }

      function withinRange(createdISO){
        if (!createdISO) return true;

        // Inclusivo
        if (isoFrom && createdISO < isoFrom) return false;
        if (isoTo && createdISO > isoTo) return false;
        return true;
      }

      function renderTable() {
        tbody.innerHTML = "";

        const est = filtroEstado.value;
        const tipo = filtroTipo.value;
        const activo = filtroActivo.value;
        const term = (buscador.value || "").toLowerCase();

        let painted = 0;

        allRequests.forEach(r => {
          // Estado
          if (est !== "todas" && r.status !== est) return;

          // Tipo
          if (tipo !== "todas" && r.request_type !== tipo) return;

          // Activo (de momento: todo viene de requests => commodities)
          const activoKey = "commodities";
          if (activo !== "todas" && activoKey !== activo) return;

          const cm = r.commodities_master;
          const itemName = cm ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name) : (r.item_id || "");

          const requester = resolveUser(r.requester_discord_id);

          // Fecha (creada)
          const createdISO = isoFromDateTime(r.created_at);
          if (!withinRange(createdISO)) return;

          // Search
          if (term) {
            const searchable = `${itemName} ${requester}`.toLowerCase();
            if (!searchable.includes(term)) return;
          }

          const tr = document.createElement("tr");
          const fechaCierre = calcFechaCerrada(r);

          tr.innerHTML = `
            <td>#${r.id}</td>
            <td><span class="${tipoTagClass(r.request_type)}">${renderTipo(r.request_type)}</span></td>
            <td><span class="${activoTagClass(activoKey)}">${renderActivoLabel(activoKey)}</span></td>
            <td>${requester}</td>
            <td><span class="${statusTagClass(r.status || "pendiente")}">${formatStatus(r.status || "pendiente")}</span></td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : "-"}</td>
            <td>${fechaCierre ? new Date(fechaCierre).toLocaleString() : "-"}</td>
          `;

          const tdDetalle = document.createElement("td");
          const btnDetalle = document.createElement("button");
          btnDetalle.type = "button";
          btnDetalle.className = "btn btn-secondary btn-sm";
          btnDetalle.textContent = "Ver";
          btnDetalle.addEventListener("click", (ev) => {
            ev.stopPropagation();
            window.open(
              `./solicitud_detalle.html?id=${encodeURIComponent(r.id)}`,
              "_blank",
              "width=720,height=760"
            );
          });
          tdDetalle.appendChild(btnDetalle);
          tr.appendChild(tdDetalle);

          tbody.appendChild(tr);
          painted++;
        });

        if (!painted) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 8;
          td.textContent = term || est !== "todas" || tipo !== "todas" || activo !== "todas" || isoFrom || isoTo
            ? "No hay resultados con esos filtros."
            : "No hay registros para mostrar.";
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      }

      function clearFilters(){
        buscador.value = "";
        filtroEstado.value = "todas";
        filtroTipo.value = "todas";
        filtroActivo.value = "todas";
        isoFrom = "";
        isoTo = "";
        dpFrom?.setISO("");
        dpTo?.setISO("");
        renderTable();
      }

      buscador.addEventListener("input", renderTable);
      filtroEstado.addEventListener("change", renderTable);
      filtroTipo.addEventListener("change", renderTable);
      filtroActivo.addEventListener("change", renderTable);
      btnClear.addEventListener("click", clearFilters);

      await loadRequests();
    });
  </script>
</body>
</html>
