<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Revisión</title>

  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.rev-main{
      padding:1.5rem;
      max-width:1100px;
      margin:0 auto;
    }

    .rev-header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:1rem;
      gap:.75rem;
      flex-wrap:wrap;
    }

    /* Toolbar estilo del proyecto */
    .rev-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      margin-bottom:.6rem;
    }
    .rev-toolbar-group{
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .rev-toolbar input[type="search"]{
      padding:0.35rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.85rem;
      font-family:inherit;
    }

    /* Modal */
    .rev-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.80);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:1rem;
    }
    .rev-modal{
      width:min(920px, 100%);
      max-height: calc(100vh - 2rem);
      overflow:auto;
    }

    .rev-form .field{ margin-bottom:.85rem; }
    .rev-form label{
      display:block;
      font-size:.8rem;
      opacity:.85;
      margin-bottom:.25rem;
    }
    .rev-form input,
    .rev-form select{
      width:100%;
      padding:0.4rem 0.55rem;
      border-radius:0.55rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.9rem;
      font-family:inherit;
    }

    .rev-grid-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.75rem 1rem;
    }
    @media (max-width: 820px){
      .rev-grid-2{ grid-template-columns:1fr; }
    }

    .rev-bottom-grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.2fr);
      gap:.9rem;
      margin-top:.2rem;
    }
    @media (max-width: 820px){
      .rev-bottom-grid{ grid-template-columns:1fr; }
    }

    .rev-modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      margin-top:.75rem;
      flex-wrap:wrap;
    }

    .rev-stock-list{
      border-radius:0.65rem;
      border:1px solid rgba(148,163,184,0.6);
      background:#020617;
      padding:0.45rem 0.6rem;
      max-height:260px;
      overflow:auto;
      font-size:.85rem;
    }

    .rev-stock-table{
      width:100%;
      border-collapse:collapse;
      font-size:.85rem;
    }
    .rev-stock-table th,
    .rev-stock-table td{
      padding:0.25rem 0.3rem;
      border-bottom:1px solid rgba(148,163,184,0.2);
    }
    .rev-stock-table thead{
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.85;
      font-size:.75rem;
    }
    .rev-stock-table th:nth-child(2),
    .rev-stock-table td:nth-child(2){
      text-align:right;
      white-space:nowrap;
    }

    /* Botones acciones tabla */
    .btn-icon{
      width:32px;
      height:32px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(2,6,23,0.75);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      padding:0;
    }
    .btn-icon.ok{ border-color:rgba(34,197,94,0.55); color:rgba(134,239,172,0.95); background:rgba(34,197,94,0.12); }
    .btn-icon.ko{ border-color:rgba(239,68,68,0.55); color:rgba(254,202,202,0.95); background:rgba(239,68,68,0.12); }
    .btn-icon:disabled{ opacity:.45; cursor:not-allowed; }

    /* Slot alerta condicional */
    #rev-alert-slot:empty{ display:none; }
    #rev-alert-slot{
      margin: .2rem 0 .75rem 0;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="rev-main">
    <div class="rev-header-row">
      <div>
        <h2>Revisión</h2>
        <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
          Revisa y decide solicitudes pendientes.
        </p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Solicitudes pendientes</h3>
      </div>

      <div class="rev-toolbar" style="padding:0 1rem 0.75rem 1rem;">
        <div class="rev-toolbar-group">
          <span style="opacity:.8;font-size:.85rem;">Solo estado <b>pendiente</b>.</span>
        </div>
        <div class="rev-toolbar-group">
          <input type="search" id="rev-search" placeholder="Buscar por ítem o solicitante..."/>
        </div>
      </div>

      <div style="max-height:520px;overflow:auto;padding:0 1rem 1rem 1rem;">
        <div id="cmp-tab-rev"></div>
      </div>
    </div>
  </main>

  <!-- MODAL APROBAR SOLICITUD -->
  <div id="rev-modal-backdrop" class="rev-modal-backdrop" style="display:none;">
    <div class="rev-modal">
      <div class="card">
        <div class="card-header">
          <h3 style="margin:0;">Aprobar solicitud</h3>
        </div>

        <form id="rev-form" class="rev-form" style="padding:1rem 1.2rem;">
          <!-- ALERTA CONDICIONAL -->
          <div id="rev-alert-slot"></div>

          <div class="rev-grid-2">
            <div class="field">
              <label>Tipo</label>
              <input id="rev-type" type="text" readonly>
            </div>
            <div class="field">
              <label>Solicitante</label>
              <input id="rev-requester" type="text" readonly>
            </div>
          </div>

          <div class="rev-grid-2">
            <div class="field">
              <label>Ítem</label>
              <input id="rev-item" type="text" readonly>
            </div>
            <div class="field">
              <label>Cantidad</label>
              <input id="rev-qty" type="text" readonly>
            </div>
          </div>

          <div class="field">
            <label>Preferencia de entrega</label>
            <input id="rev-preferred" type="text" readonly>
          </div>

          <div class="field">
            <label>Almacén / Lugar de transacción</label>
            <select id="rev-warehouse-select" required>
              <option value="">Selecciona un almacén...</option>
            </select>
          </div>

          <div class="rev-bottom-grid">
            <div class="field">
              <label>Fecha límite de entrega</label>
              <!-- DAT-01 casteado aquí -->
              <div id="cmp-dat-01"></div>
            </div>

            <div class="field">
              <label>Stock por almacén</label>
              <div id="rev-stock-list" class="rev-stock-list"></div>
            </div>
          </div>

          <div class="rev-modal-actions">
            <button type="button" id="rev-cancel" class="btn btn-secondary">Cancelar</button>
            <button type="submit" id="rev-approve" class="btn btn-primary">Aprobar solicitud</button>
          </div>

          <p style="opacity:.75;font-size:.85rem;margin-top:.6rem;">
            Una vez aprobada o rechazada, la decisión no se puede deshacer desde la aplicación.
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- CAST TABLA + DAT-01 -->
  <script type="module">
    import { loadComponentById } from './modules/ui_components.js';

    function ensureTbodyId(containerId, wantedId){
      const host = document.getElementById(containerId);
      if (!host) return;

      const direct = host.querySelector(`#${CSS.escape(wantedId)}`);
      if (direct) return;

      const slot = host.querySelector('[data-slot="tbody"]');
      if (slot) { slot.id = wantedId; return; }

      const tb = host.querySelector('tbody');
      if (tb) tb.id = wantedId;
    }

    await loadComponentById('./components/tab-06.html', 'cmp-tab-rev');
    ensureTbodyId('cmp-tab-rev', 'rev-tbody');

    await loadComponentById('./components/dat-01.html', 'cmp-dat-01');
  </script>

  <!-- LÓGICA ORIGINAL (SIN CAMBIOS) + mejoras popup -->
  <script type="module">
    import { getOrgStatus } from './modules/profile.js';
    import { loadComponentById } from './modules/ui_components.js';
    import { createDatePicker } from './modules/ui_datepicker.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      function formatStatus(st) {
        const map = {
          pendiente: 'Pendiente',
          aprobada: 'Aprobada',
          rechazada: 'Rechazada',
          completada: 'Completada',
          cancelada: 'Cancelada'
        };
        return map[st] || st;
      }

      function renderTipo(tipo) {
        if (!tipo) return '-';
        return tipo === 'compra' ? 'Compra' : 'Venta';
      }

      /* ───── 1) Sesión + org_status ───── */
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = './index.html'; return; }

      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      if (typeof window.loadHeader === 'function') await window.loadHeader('app');
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => { await supa.auth.signOut(); window.location.href="./index.html"; },
          () => window.location.href='./perfil.html'
        );
      }

      /* ───── 2) Permisos revisión ───── */
      const { data: meRow } = await supa
        .from('users')
        .select('tesoro_internal_role')
        .eq('id', session.user.id)
        .maybeSingle();

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === 'string') myRole = myRole.trim();

      let roleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber) && myRole !== '') {
          const { data, error } = await supa.from('roles_app').select('*').eq('id', asNumber).maybeSingle();
          if (!error) roleRow = data;
        }
        if (!roleRow) {
          const { data, error } = await supa.from('roles_app').select('*').ilike('role_name', myRole).maybeSingle();
          if (!error) roleRow = data;
        }
      }

      let revLevel = roleRow?.revision ?? 0;
      if (!revLevel || revLevel === 0) {
        alert('No tienes acceso al módulo de Revisión.');
        window.location.href = './app_ui.html';
        return;
      }
      const readOnly = (revLevel === 1);

      /* ───── 3) Aux: usuarios + almacenes ───── */
      const usersById = {};
      const { data: users } = await supa.from('users').select('id, handle_name, discord_username');
      (users || []).forEach(u => { usersById[u.id] = u; });

      const warehousesById = {};
      const { data: warehouses, error: whError } = await supa
        .from('warehouses')
        .select('id, name')
        .order('name', { ascending: true });
      if (whError) console.error('Error cargando almacenes:', whError);
      (warehouses || []).forEach(w => { warehousesById[w.id] = w; });

      /* Rellenar select del modal */
      const warehouseSelect = document.getElementById('rev-warehouse-select');
      (warehouses || []).forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = w.name || 'Almacén';
        warehouseSelect.appendChild(opt);
      });

      /* ───── 4) DOM tabla + modal ───── */
      const tbody         = document.getElementById('rev-tbody');
      const searchInput   = document.getElementById('rev-search');

      const modalBackdrop = document.getElementById('rev-modal-backdrop');
      const revForm       = document.getElementById('rev-form');
      const revCancelBtn  = document.getElementById('rev-cancel');

      const revType       = document.getElementById('rev-type');
      const revRequester  = document.getElementById('rev-requester');
      const revItem       = document.getElementById('rev-item');
      const revQty        = document.getElementById('rev-qty');
      const revPreferred  = document.getElementById('rev-preferred');
      const revStockList  = document.getElementById('rev-stock-list');

      const alertSlot     = document.getElementById('rev-alert-slot');

      // DAT-01 date picker
      const datRoot = document.getElementById('cmp-dat-01');
      let dp = null;

      function initDatePicker(){
        // default +7 días
        const def = new Date();
        def.setDate(def.getDate() + 7);

        dp = createDatePicker(datRoot, {
          minDate: new Date(),
          defaultDate: def,
          onChange(){ /* no-op: leemos dp.getDate() al aprobar */ }
        });
      }

      // Se asegura de inicializarlo una sola vez (DAT-01 ya casteado)
      initDatePicker();

      // Stock cache por almacén (del ítem actual)
      let stockByWarehouse = {}; // { [warehouse_id]: qty }
      let currentRequest = null;

      function tipoTagClass(tipo) {
        return (tipo === 'venta') ? 'tag tag--venta' : 'tag tag--compra';
      }
      function statusTagClass(st) {
        return `tag tag--${st}`;
      }

      function clearAlert(){
        alertSlot.innerHTML = '';
      }

      async function showLowStockAlert(){
        // castear ALR-02 dentro del slot
        alertSlot.innerHTML = '';
        await loadComponentById('./components/alr-02.html', 'rev-alert-slot');

        // Intentar rellenar texto de forma robusta
        const root = alertSlot;
        const titleEl = root.querySelector('[data-alr-title], .alr__title, strong');
        const bodyEl  = root.querySelector('[data-alr-body], .alr__body, p');

        if (titleEl) titleEl.textContent = 'Stock insuficiente';
        if (bodyEl) bodyEl.textContent =
          'El almacén seleccionado no dispone de stock suficiente para cubrir esta solicitud de COMPRA. ' +
          'Puedes cambiar el almacén o continuar bajo tu responsabilidad.';
      }

      async function evaluateStockCondition(){
        clearAlert();
        if (!currentRequest) return;

        const type = currentRequest.request_type || 'compra';
        if (type !== 'compra') return; // en venta, stock indiferente

        const wid = warehouseSelect.value;
        if (!wid) return;

        const have = Number(stockByWarehouse[wid] || 0);
        const need = Number(currentRequest.quantity || 0);

        if (need > have) {
          await showLowStockAlert();
        }
      }

      warehouseSelect.addEventListener('change', () => {
        evaluateStockCondition();
      });

      async function loadStockForItem(itemId) {
        stockByWarehouse = {};
        revStockList.textContent = 'Cargando stock...';

        const { data, error } = await supa
          .from('warehouse_items')
          .select(`warehouse_id, quantity, warehouses(name)`)
          .eq('commodity_id', itemId);

        if (error) {
          console.error('Error cargando stock:', error);
          revStockList.textContent = 'No se ha podido cargar el stock.';
          return;
        }

        const rows = data || [];
        if (!rows.length) {
          revStockList.textContent = 'No hay stock registrado para este ítem.';
          return;
        }

        rows.forEach(r => { stockByWarehouse[r.warehouse_id] = Number(r.quantity || 0); });

        const table = document.createElement('table');
        table.className = 'rev-stock-table';

        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>ALMACÉN</th><th>CANT.</th></tr>`;
        table.appendChild(thead);

        const tb = document.createElement('tbody');
        rows
          .sort((a,b)=> (a.warehouses?.name||'').localeCompare(b.warehouses?.name||''))
          .forEach(r => {
            const tr = document.createElement('tr');
            const wName = r.warehouses?.name || warehousesById[r.warehouse_id]?.name || r.warehouse_id;
            tr.innerHTML = `<td>${wName}</td><td>${Number(r.quantity||0)}</td>`;
            tb.appendChild(tr);
          });

        table.appendChild(tb);
        revStockList.innerHTML = '';
        revStockList.appendChild(table);
      }

      async function openModalForRequest(r, itemName, requesterName) {
        currentRequest = r;

        // reset
        clearAlert();
        warehouseSelect.value = '';
        // reset date picker to +7
        if (dp) {
          const def = new Date();
          def.setDate(def.getDate() + 7);
          dp.setDate(def);
        }

        revType.value      = renderTipo(r.request_type);
        revRequester.value = requesterName || '';
        revItem.value      = itemName || '';
        revQty.value       = r.quantity ?? '';

        const preferredName = r.preferred_warehouse_id
          ? (warehousesById[r.preferred_warehouse_id]?.name || `ID ${r.preferred_warehouse_id}`)
          : 'Cualquier almacén';

        revPreferred.value = preferredName;

        await loadStockForItem(r.item_id);

        modalBackdrop.style.display = 'flex';
      }

      function closeModal(){
        modalBackdrop.style.display = 'none';
        currentRequest = null;
        clearAlert();
      }

      revCancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
      modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

      /* ───── 5) Carga solicitudes pendientes ───── */
      let pendingRequests = [];

      async function loadPendingRequests() {
        const { data, error } = await supa
          .from('requests')
          .select(`
            id,
            request_type,
            item_id,
            quantity,
            status,
            created_at,
            requester_discord_id,
            preferred_warehouse_id,
            commodities_master(name, symbol)
          `)
          .eq('status', 'pendiente')
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error cargando pendientes:', error);
          return;
        }

        pendingRequests = data || [];
        renderTable();
      }

      function renderTable(){
        tbody.innerHTML = '';
        const term = (searchInput.value || '').toLowerCase();

        if (!pendingRequests.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 9;
          td.textContent = 'No hay solicitudes pendientes de revisión.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        pendingRequests.forEach(r => {
          const cm = r.commodities_master;
          const itemName = cm
            ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
            : (r.item_id || '');

          const u = usersById[r.requester_discord_id];
          const requesterName = u?.handle_name || u?.discord_username || r.requester_discord_id;

          if (term) {
            const haystack = (itemName + ' ' + requesterName).toLowerCase();
            if (!haystack.includes(term)) return;
          }

          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>#${r.id}</td>
            <td><span class="${tipoTagClass(r.request_type)}">${renderTipo(r.request_type)}</span></td>
            <td>${itemName}</td>
            <td>${r.quantity}</td>
            <td>${requesterName}</td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</td>
            <td><span class="${statusTagClass(r.status || 'pendiente')}">${formatStatus(r.status || 'pendiente')}</span></td>
          `;

          // Detalle
          const tdDetalle = document.createElement('td');
          const btnDetalle = document.createElement('button');
          btnDetalle.type = 'button';
          btnDetalle.className = 'btn btn-secondary btn-sm';
          btnDetalle.textContent = 'Ver';
          btnDetalle.addEventListener('click', (ev) => {
            ev.stopPropagation();
            window.open(`./detalle_solicitud.html?id=${encodeURIComponent(r.id)}`, '_blank', 'width=780,height=820');
          });
          tdDetalle.appendChild(btnDetalle);
          tr.appendChild(tdDetalle);

          // Acciones
          const tdAcc = document.createElement('td');
          const canAct = !readOnly;

          const okBtn = document.createElement('button');
          okBtn.type = 'button';
          okBtn.className = 'btn-icon ok';
          okBtn.innerHTML = '✓';
          okBtn.disabled = !canAct;
          okBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;
            await openModalForRequest(r, itemName, requesterName);
          });

          const koBtn = document.createElement('button');
          koBtn.type = 'button';
          koBtn.className = 'btn-icon ko';
          koBtn.style.marginLeft = '0.35rem';
          koBtn.innerHTML = '✕';
          koBtn.disabled = !canAct;
          koBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;

            const okConfirm = confirm('¿Seguro que quieres rechazar esta solicitud?');
            if (!okConfirm) return;

            const { error } = await supa
              .from('requests')
              .update({ status: 'rechazada', approver_discord_id: session.user.id })
              .eq('id', r.id);

            if (error) {
              console.error('Error rechazando:', error);
              alert('No se ha podido rechazar la solicitud.');
              return;
            }

            if (r.requester_discord_id) {
              await supa.from('notifications').insert({
                user_id: r.requester_discord_id,
                type: 'request_rejected',
                title: `Solicitud #${r.id} rechazada`,
                body: 'Tesoro ha rechazado tu solicitud en la fase de revisión.',
                link_url: `./detalle_solicitud.html?id=${encodeURIComponent(r.id)}`,
                related_request_id: r.id,
                level: 'danger'
              });
            }

            await loadPendingRequests();
          });

          tdAcc.appendChild(okBtn);
          tdAcc.appendChild(koBtn);
          tr.appendChild(tdAcc);

          tbody.appendChild(tr);
        });
      }

      searchInput.addEventListener('input', renderTable);

      /* ───── 6) Aprobar (submit) ───── */
      revForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (readOnly) { alert('Tienes permisos de solo lectura.'); return; }
        if (!currentRequest) return;

        const warehouseId = warehouseSelect.value;
        if (!warehouseId) { alert('Debes seleccionar un almacén.'); return; }

        const selectedDate = dp ? dp.getDate() : null;
        if (!selectedDate) { alert('Debes seleccionar una fecha límite de entrega.'); return; }

        // Re-evaluar alerta (por si el usuario no cambió select)
        await evaluateStockCondition();

        const dueDate = selectedDate.toISOString().split('T')[0];

        const { error } = await supa
          .from('requests')
          .update({
            status: 'aprobada',
            warehouse_id: warehouseId,
            due_date: dueDate,
            approved_at: new Date().toISOString(),
            approver_discord_id: session.user.id
          })
          .eq('id', currentRequest.id);

        if (error) {
          console.error('Error aprobando:', error);
          alert('No se ha podido aprobar la solicitud.');
          return;
        }

        if (currentRequest.requester_discord_id) {
          await supa.from('notifications').insert({
            user_id: currentRequest.requester_discord_id,
            type: 'request_approved',
            title: `Solicitud #${currentRequest.id} aprobada`,
            body: `Tesoro ha aprobado tu solicitud. Plazo máx.: ${dueDate}.`,
            link_url: `./detalle_solicitud.html?id=${encodeURIComponent(currentRequest.id)}`,
            related_request_id: currentRequest.id,
            level: 'info'
          });
        }

        closeModal();
        await loadPendingRequests();
      });

      await loadPendingRequests();
    });
  </script>
</body>
</html>
