<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Revisión de solicitudes</title>

  <!-- Estilos globales + design system -->
  <link rel="stylesheet" href="./style.css"/>
  <link rel="stylesheet" href="./style_prueba.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.rev-main{
      padding:1.5rem;
      max-width:1100px;
      margin:0 auto;
    }

    .rev-header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:1rem;
      gap:.75rem;
      flex-wrap:wrap;
    }

    .rev-toolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      margin-bottom:.6rem;
    }
    .rev-toolbar-group{
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .rev-toolbar input[type="search"]{
      padding:0.35rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.8rem;
      font-family:inherit;
    }

    /* Tabla principal */
    .rev-table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    .rev-table thead{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.85;
    }
    .rev-table th,.rev-table td{
      padding:0.38rem 0.5rem;
      border-bottom:1px solid rgba(148,163,184,0.28);
      vertical-align:middle;
    }
    .rev-table tbody tr{ transition:background .12s ease-out; }
    .rev-table tbody tr:hover{ background:rgba(15,23,42,0.9); }

    /* Centrados: Tipo(2), Cant(4), Solicitante(5), Creada(6), Estado(7), Detalle(8), Acciones(9) */
    .rev-table th:nth-child(2), .rev-table td:nth-child(2),
    .rev-table th:nth-child(4), .rev-table td:nth-child(4),
    .rev-table th:nth-child(5), .rev-table td:nth-child(5),
    .rev-table th:nth-child(6), .rev-table td:nth-child(6),
    .rev-table th:nth-child(7), .rev-table td:nth-child(7),
    .rev-table th:nth-child(8), .rev-table td:nth-child(8),
    .rev-table th:nth-child(9), .rev-table td:nth-child(9){
      text-align:center;
    }

    /* Acciones: botones redondos */
    .btn-icon{
      width:28px;height:28px;border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;color:#e5e7eb;
      font-size:.8rem;display:inline-flex;align-items:center;justify-content:center;
      padding:0;cursor:pointer;
    }
    .btn-icon.ok{ background:#22c55e; color:#022c22; border-color:#22c55e; }
    .btn-icon.ko{ background:#ef4444; color:#fef2f2; border-color:#ef4444; }
    .btn-icon:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-disabled{ opacity:.6; cursor:not-allowed; }

    .help-text{ font-size:.75rem; opacity:.75; margin-top:.15rem; }

    /* Modal */
    .rev-modal-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,0.8);
      display:flex; align-items:center; justify-content:center;
      z-index:60;
    }
    .rev-modal{
      background:#020617;
      border-radius:0.9rem;
      padding:1rem 1.15rem;
      max-width:980px;
      width:min(980px, calc(100vw - 24px));
      box-shadow:0 18px 40px rgba(0,0,0,0.75);
    }
    .rev-modal-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:.75rem; flex-wrap:wrap;
      margin-bottom:.7rem;
    }
    .rev-modal-body{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:1rem;
    }
    @media (max-width: 900px){
      .rev-modal-body{ grid-template-columns:1fr; }
    }

    .rev-form .field{ margin-bottom:.7rem; }
    .rev-form label{ display:block; font-size:.8rem; opacity:.8; margin-bottom:.2rem; }
    .rev-form input, .rev-form select, .rev-form textarea{
      width:100%;
      padding:0.4rem 0.55rem;
      border-radius:0.55rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.9rem;
      font-family:inherit;
    }

    .rev-modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      margin-top:.75rem;
      flex-wrap:wrap;
    }

    /* Wrap derecha */
    .rev-side-wrap{
      border:1px solid rgba(148,163,184,0.28);
      border-radius:0.8rem;
      padding:.75rem .85rem;
      background:rgba(2,6,23,0.35);
    }
    .rev-side-title{
      font-size:.85rem;
      opacity:.85;
      text-transform:uppercase;
      letter-spacing:.06em;
      margin:0 0 .5rem 0;
    }
    .rev-side-sep{
      height:1px;
      background:rgba(148,163,184,0.22);
      margin:.7rem 0;
    }

    /* Tablas del lado derecho (mismo tamaño visual, PERO dos tablas distintas) */
    .rev-mini-table{
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    .rev-mini-table td{
      padding:.42rem 0;
      border-bottom:1px solid rgba(148,163,184,0.22);
      vertical-align:middle;
    }
    .rev-mini-table tr:last-child td{ border-bottom:none; }
    .rev-mini-k{ opacity:.85; font-size:.82rem; }
    .rev-mini-v{
      text-align:right;
      font-variant-numeric:tabular-nums;
      white-space:nowrap;
    }

    /* Host del datepicker */
    .rev-date-host .date-picker{ width:100%; }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="rev-main">
    <div class="rev-header-row">
      <div>
        <h2>Revisión</h2>
        <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
          Revisa solicitudes pendientes, aprueba asignando almacén y fecha límite, o rechaza.
        </p>
      </div>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>Solicitudes pendientes</h3>
      </div>

      <div class="rev-toolbar">
        <div class="rev-toolbar-group">
          <input type="search" id="rev-search" placeholder="Buscar por ítem o solicitante..."/>
        </div>
      </div>

      <div style="max-height:520px;overflow:auto;margin-top:.2rem;">
        <div class="table-container">
          <table class="rev-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Tipo</th>
                <th>Ítem</th>
                <th>Cant.</th>
                <th>Solicitante</th>
                <th>Creada</th>
                <th>Estado</th>
                <th>Detalle</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="rev-tbody"></tbody>
          </table>
        </div>
      </div>

     </div>
  </main>

  <!-- MODAL APROBACIÓN -->
  <div id="rev-modal-backdrop" class="rev-modal-backdrop" style="display:none;">
    <div class="rev-modal">
      <div class="rev-modal-header">
        <div>
          <h3 style="margin:0;">Aprobar solicitud</h3>
          <div class="help-text" style="margin-top:.15rem;">Configura almacén y fecha límite y confirma.</div>
        </div>
        <button type="button" id="rev-cancel" class="btn btn-secondary">Cerrar</button>
      </div>

      <form id="rev-form" class="rev-form">
        <div class="rev-modal-body">
          <!-- IZQUIERDA -->
          <div>
            <div class="field">
              <label>Tipo</label>
              <input id="rev-type" type="text" readonly />
            </div>
            <div class="field">
              <label>Solicitante</label>
              <input id="rev-requester" type="text" readonly />
            </div>
            <div class="field">
              <label>Material</label>
              <input id="rev-item" type="text" readonly />
            </div>
            <div class="field">
              <label>Cantidad</label>
              <input id="rev-qty" type="text" readonly />
            </div>
            <div class="field">
              <label>Preferencia de entrega</label>
              <input id="rev-preferred" type="text" readonly />
            </div>

            <div class="field">
              <label>Almacén asignado</label>
              <select id="rev-warehouse-select" required>
                <option value="">Selecciona un almacén...</option>
              </select>
            </div>

            <!-- ✅ Datepicker casteado (DAT-01) -->
            <div class="field">
              <div id="rev-date-host" class="rev-date-host"></div>
              <input id="rev-due-iso" type="hidden" value="" />
            </div>
          </div>

          <!-- DERECHA: 2 TABLAS + ALERTA -->
          <div>
            <div class="rev-side-wrap">
              <!-- TABLA 1: PRECIOS -->
              <h4 class="rev-side-title">Precios</h4>
              <table class="rev-mini-table" aria-label="Precios">
                <tbody id="rev-price-tbody">
                  <tr><td class="rev-mini-k">Cargando...</td><td class="rev-mini-v">-</td></tr>
                </tbody>
              </table>

              <div class="rev-side-sep"></div>

              <!-- TABLA 2: STOCK POR ALMACÉN -->
              <h4 class="rev-side-title">Stock por almacén</h4>
              <table class="rev-mini-table" aria-label="Stock por almacén">
                <tbody id="rev-stock-tbody">
                  <tr><td class="rev-mini-k">—</td><td class="rev-mini-v">—</td></tr>
                </tbody>
              </table>

              <!-- ALERTA ALR-02 DEBAJO (NO DENTRO DE NINGUNA TABLA) -->
              <div id="rev-alr-host" style="display:none; margin-top:.65rem;"></div>
            </div>
          </div>
        </div>

        <div class="rev-modal-actions">
          <button type="submit" class="btn btn-primary" id="rev-approve-btn">
            Aprobar solicitud
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';
    import { loadComponentById } from './modules/ui_components.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      function formatStatus(st) {
        const map = {
          pendiente: 'Pendiente',
          aprobada: 'Aprobada',
          rechazada: 'Rechazada',
          completada: 'Completada',
          cancelada: 'Cancelada'
        };
        return map[st] || st;
      }

      function renderTipo(tipo) {
        if (!tipo) return '-';
        return tipo === 'compra' ? 'Compra' : 'Venta';
      }

      /* ✅ TAGs del sistema */
      function statusTagClass(st){ return `tag tag--${st}`; }
      function tipoTagClass(tipo){ return (tipo === 'venta') ? 'tag tag--venta' : 'tag tag--compra'; }

      /* ───── 1) Sesión + org_status ───── */
      const { data: { session } } = await supa.auth.getSession();
      if (!session) { window.location.href = './index.html'; return; }

      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      if (typeof window.loadHeader === 'function') await window.loadHeader('app');
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => { await supa.auth.signOut(); window.location.href = "./index.html"; },
          () => window.location.href = './perfil.html'
        );
      }

      /* ───── 2) Permisos ───── */
      const { data: meRow, error: meError } = await supa
        .from('users')
        .select('tesoro_internal_role')
        .eq('id', session.user.id)
        .maybeSingle();
      if (meError) console.error('Error leyendo rol interno:', meError);

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === 'string') myRole = myRole.trim();

      let roleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber) && myRole !== '') {
          const { data, error } = await supa.from('roles_app').select('*').eq('id', asNumber).maybeSingle();
          if (!error) roleRow = data;
        }
        if (!roleRow) {
          const { data, error } = await supa.from('roles_app').select('*').ilike('role_name', myRole).maybeSingle();
          if (!error) roleRow = data;
        }
      }

      let revLevel = roleRow?.revision ?? 0;
      if (!revLevel || revLevel === 0) {
        alert('No tienes acceso al módulo de Revisión.');
        window.location.href = './app_ui.html';
        return;
      }
      const readOnly = (revLevel === 1);

      /* ───── 3) Usuarios + almacenes ───── */
      const usersById = {};
      const { data: users } = await supa.from('users').select('id, handle_name, discord_username');
      (users || []).forEach(u => { usersById[u.id] = u; });

      const warehousesById = {};
      const { data: warehouses, error: whError } = await supa
        .from('warehouses')
        .select('id, name, system')
        .order('name', { ascending: true });
      if (whError) console.error('Error cargando almacenes:', whError);
      (warehouses || []).forEach(w => { warehousesById[w.id] = w; });

      /* ───── 4) DOM ───── */
      const tbody         = document.getElementById('rev-tbody');
      const searchInput   = document.getElementById('rev-search');

      const modalBackdrop = document.getElementById('rev-modal-backdrop');
      const revForm       = document.getElementById('rev-form');
      const revCancelBtn  = document.getElementById('rev-cancel');

      const revType       = document.getElementById('rev-type');
      const revRequester  = document.getElementById('rev-requester');
      const revItem       = document.getElementById('rev-item');
      const revQty        = document.getElementById('rev-qty');
      const revPreferred  = document.getElementById('rev-preferred');

      const warehouseSelect = document.getElementById('rev-warehouse-select');
      const dueIsoHidden    = document.getElementById('rev-due-iso');

      const priceTbody = document.getElementById('rev-price-tbody');
      const stockTbody = document.getElementById('rev-stock-tbody');
      const alrHost    = document.getElementById('rev-alr-host');

      (warehouses || []).forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = w.name || 'Almacén';
        warehouseSelect.appendChild(opt);
      });

      /* ───────────── DAT-01 (casteado) + init ───────────── */
      await loadComponentById('./components/dat-01.html', 'rev-date-host');

      function initDat01(pickerRoot, opts = {}) {
        if (!pickerRoot) return null;

        const input = pickerRoot.querySelector('.date-input');
        const popover = pickerRoot.querySelector('.date-popover');
        const monthLabel = pickerRoot.querySelector('.date-month');
        const grid = pickerRoot.querySelector('.date-grid');
        const navs = pickerRoot.querySelectorAll('.date-nav');
        const btnClear = pickerRoot.querySelector('.date-clear');
        const btnToday = pickerRoot.querySelector('.date-today');
        const btnPlus = pickerRoot.querySelectorAll('.date-plus');

        const locale = pickerRoot.dataset.locale || 'es-ES';
        const monthNames = new Intl.DateTimeFormat(locale, { month: 'long' });

        const pad2 = (n) => String(n).padStart(2, '0');
        const toISO = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        const formatDisplay = (iso) => {
          if (!iso) return '';
          const [y,m,d] = iso.split('-').map(Number);
          const dt = new Date(y, m-1, d);
          return new Intl.DateTimeFormat(locale, { year:'numeric', month:'2-digit', day:'2-digit' }).format(dt);
        };

        const minToday = !!opts.minToday;

        function buildCalendar(target, year, month, selectedISO) {
          target.innerHTML = '';
          const first = new Date(year, month, 1);
          const last  = new Date(year, month + 1, 0);
          const firstWeekday = (first.getDay() + 6) % 7;
          const daysInMonth = last.getDate();

          const prevLast = new Date(year, month, 0).getDate();
          for (let i = 0; i < firstWeekday; i++) {
            const day = prevLast - (firstWeekday - 1 - i);
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day muted';
            el.textContent = day;
            target.appendChild(el);
          }

          const todayISO = toISO(new Date());

          for (let d = 1; d <= daysInMonth; d++) {
            const iso = `${year}-${pad2(month+1)}-${pad2(d)}`;
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day';
            el.dataset.iso = iso;
            el.textContent = d;

            if (iso === selectedISO) el.classList.add('selected');
            if (iso === todayISO) el.classList.add('today');

            if (minToday && iso < todayISO) {
              el.classList.add('muted');
              el.disabled = true;
            }
            target.appendChild(el);
          }

          const total = firstWeekday + daysInMonth;
          const remain = (7 - (total % 7)) % 7;
          for (let i = 1; i <= remain; i++) {
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'date-day muted';
            el.textContent = i;
            target.appendChild(el);
          }
        }

        function decidePopoverDirection() {
          const rect = pickerRoot.getBoundingClientRect();
          const viewportH = window.innerHeight || document.documentElement.clientHeight;

          const wasHidden = !pickerRoot.classList.contains('open');
          if (wasHidden) {
            pickerRoot.classList.add('open');
            popover.setAttribute('aria-hidden', 'false');
          }

          const popH = popover.getBoundingClientRect().height;

          if (wasHidden) {
            pickerRoot.classList.remove('open');
            popover.setAttribute('aria-hidden', 'true');
          }

          const spaceBelow = viewportH - rect.bottom;
          const spaceAbove = rect.top;

          const needsUp = spaceBelow < (popH + 12) && spaceAbove > spaceBelow;
          pickerRoot.classList.toggle('open-up', needsUp);
        }

        let view = new Date();
        view.setDate(1);

        let selectedISO = '';

        function render() {
          const y = view.getFullYear();
          const m = view.getMonth();
          const monthText = monthNames.format(new Date(y, m, 1));
          monthLabel.textContent = `${monthText.charAt(0).toUpperCase()}${monthText.slice(1)} ${y}`;
          buildCalendar(grid, y, m, selectedISO);
        }

        function open() { decidePopoverDirection(); pickerRoot.classList.add('open'); popover.setAttribute('aria-hidden','false'); }
        function close(){ pickerRoot.classList.remove('open'); popover.setAttribute('aria-hidden','true'); }
        function toggle(){ pickerRoot.classList.contains('open') ? close() : open(); }

        function setISO(iso) {
          selectedISO = iso || '';
          input.value = formatDisplay(selectedISO);
          if (selectedISO) {
            const [y,m] = selectedISO.split('-');
            view = new Date(Number(y), Number(m)-1, 1);
          }
          render();
          close();
          if (typeof opts.onChange === 'function') opts.onChange(selectedISO);
        }

        input.addEventListener('click', toggle);

        navs.forEach(btn => {
          btn.addEventListener('click', () => {
            const dir = Number(btn.dataset.dir || 0);
            view.setMonth(view.getMonth() + dir);
            view.setDate(1);
            render();
            if (pickerRoot.classList.contains('open')) decidePopoverDirection();
          });
        });

        grid.addEventListener('click', (e) => {
          const t = e.target;
          if (!t.classList.contains('date-day')) return;
          if (t.classList.contains('muted')) return;
          const iso = t.dataset.iso;
          if (!iso) return;
          setISO(iso);
        });

        btnClear?.addEventListener('click', () => setISO(''));
        btnToday?.addEventListener('click', () => setISO(toISO(new Date())));
        btnPlus?.forEach(b => {
          b.addEventListener('click', () => {
            const days = Number(b.dataset.days || 0);
            const now = new Date();
            now.setDate(now.getDate() + days);
            setISO(toISO(now));
          });
        });

        window.addEventListener('resize', () => { if (pickerRoot.classList.contains('open')) decidePopoverDirection(); });
        window.addEventListener('scroll', () => { if (pickerRoot.classList.contains('open')) decidePopoverDirection(); }, { passive:true });
        document.addEventListener('click', (e) => { if (!pickerRoot.contains(e.target)) close(); });

        render();

        return { setISO, getISO: () => selectedISO };
      }

      let selectedDueDate = null;
      const datRoot = document.querySelector('#rev-date-host .date-picker');
      const datApi = initDat01(datRoot, {
        minToday: true,
        onChange: (iso) => {
          dueIsoHidden.value = iso || '';
          selectedDueDate = iso ? new Date(iso + 'T00:00:00') : null;
        }
      });

      function setDefaultDueDatePlusDays(days) {
        const d = new Date();
        d.setDate(d.getDate() + days);
        const iso = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        datApi?.setISO(iso);
      }

      /* ───────────── ALR-02 (casteada de verdad) ───────────── */
      await loadComponentById('./components/alr-02.html', 'rev-alr-host');
      alrHost.style.display = 'none';

      const ALR_MSG = 'El stock disponible en el almacen seleccionado es menor a la cantidad demandada de ese material';

      function forceSetAlertText(root, message){
        if (!root) return;

        // 1) intentamos slots típicos
        const preferred =
          root.querySelector('[data-slot="message"]') ||
          root.querySelector('[data-slot="text"]') ||
          root.querySelector('[data-slot="body"]') ||
          root.querySelector('.alr__message') ||
          root.querySelector('.alr__text') ||
          root.querySelector('.alert__message') ||
          root.querySelector('.alert__text');

        if (preferred) { preferred.textContent = message; return; }

        // 2) si el componente no tiene slot claro: sobreescribimos el primer bloque de texto "razonable"
        const candidates = Array.from(root.querySelectorAll('p, div, span'))
          .filter(el => {
            const t = (el.textContent || '').trim();
            return t.length >= 8 && t.length <= 160;
          });

        if (candidates.length) {
          candidates[0].textContent = message;
          return;
        }

        // 3) último recurso: metemos un <p>
        const p = document.createElement('p');
        p.style.margin = '0';
        p.textContent = message;
        root.appendChild(p);
      }

      forceSetAlertText(alrHost, ALR_MSG);

      function showInsufficientStockAlert(show){
        alrHost.style.display = show ? 'block' : 'none';
      }

      /* ───────────── TABLA 1: PRECIOS ───────────── */
      function fmtNum(n) {
        if (n === null || n === undefined || Number.isNaN(Number(n))) return '-';
        return Number(n).toFixed(2);
      }

      function paintPrices({ avgWarehouseSystem, avgSystemAllWarehouses, lastTxPrice }){
        priceTbody.innerHTML = `
          <tr>
            <td class="rev-mini-k">Precio medio del sistema</td>
            <td class="rev-mini-v">${avgWarehouseSystem === null ? '-' : fmtNum(avgWarehouseSystem)} aUEC/SCU</td>
          </tr>
          <tr>
            <td class="rev-mini-k">Precio medio almacenes del sistema</td>
            <td class="rev-mini-v">${avgSystemAllWarehouses === null ? '-' : fmtNum(avgSystemAllWarehouses)} aUEC/SCU</td>
          </tr>
          <tr>
            <td class="rev-mini-k">Última transacción</td>
            <td class="rev-mini-v">${lastTxPrice === null ? '-' : fmtNum(lastTxPrice)} aUEC/SCU</td>
          </tr>
        `;
      }

      async function tryGetPriceDataFromTable(tableName, itemId, system) {
        let q = supa.from(tableName).select('*').limit(500);
        q = q.or(`commodity_id.eq.${itemId},item_id.eq.${itemId}`);
        if (system) q = q.or(`system.eq.${system},system_name.eq.${system}`);

        const { data, error } = await q;
        if (error) return null;
        if (!data || !data.length) return { rows: [] };

        const getPrice = (r) => {
          const v = r.price_per_scu ?? r.price ?? r.avg_price ?? null;
          const n = Number(v);
          return Number.isFinite(n) ? n : null;
        };

        const rows = data
          .map(r => ({
            warehouse_id: r.warehouse_id ?? r.warehouse ?? null,
            system: r.system ?? r.system_name ?? null,
            price: getPrice(r),
            created_at: r.created_at ?? r.ts ?? r.date ?? null
          }))
          .filter(r => r.price !== null);

        return { rows };
      }

      async function loadPricingForItem(itemId, warehouseId) {
        if (!itemId) { priceTbody.innerHTML = `<tr><td class="rev-mini-k">Ítem no reconocido.</td><td class="rev-mini-v">-</td></tr>`; return; }
        if (!warehouseId) { priceTbody.innerHTML = `<tr><td class="rev-mini-k">Selecciona un almacén.</td><td class="rev-mini-v">-</td></tr>`; return; }

        priceTbody.innerHTML = `<tr><td class="rev-mini-k">Cargando...</td><td class="rev-mini-v">-</td></tr>`;

        const wh = warehousesById[warehouseId] || null;
        const system = (wh?.system || '').trim() || null;

        const candidates = ['warehouse_prices','commodity_prices','commodities_prices','uex_prices'];

        let rowsPack = null;
        for (const t of candidates) {
          const pack = await tryGetPriceDataFromTable(t, itemId, system);
          if (pack) { rowsPack = pack; break; }
        }

        let avgWarehouseSystem = null;
        let avgSystemAllWarehouses = null;

        if (rowsPack && rowsPack.rows && rowsPack.rows.length) {
          const rows = rowsPack.rows;
          const inSystem = system ? rows.filter(r => (r.system || '').toLowerCase() === system.toLowerCase()) : rows;

          if (inSystem.length) {
            avgWarehouseSystem = inSystem.reduce((a,r) => a + r.price, 0) / inSystem.length;
          }

          const byWh = {};
          inSystem.forEach(r => {
            const k = r.warehouse_id || 'unknown';
            byWh[k] = byWh[k] || [];
            byWh[k].push(r.price);
          });
          const whMeans = Object.values(byWh)
            .map(arr => arr.reduce((a,x)=>a+x,0)/arr.length)
            .filter(n => Number.isFinite(n));
          if (whMeans.length) {
            avgSystemAllWarehouses = whMeans.reduce((a,x)=>a+x,0) / whMeans.length;
          }
        }

        let lastTxPrice = null;
        const txCandidates = ['commodity_transactions','treasury_transactions','market_transactions'];
        for (const t of txCandidates) {
          const { data, error } = await supa
            .from(t)
            .select('*')
            .or(`commodity_id.eq.${itemId},item_id.eq.${itemId}`)
            .order('created_at', { ascending:false })
            .limit(1);
          if (!error && data && data.length) {
            const r = data[0];
            const v = r.price_per_scu ?? r.price ?? r.unit_price ?? null;
            const n = Number(v);
            if (Number.isFinite(n)) lastTxPrice = n;
            break;
          }
        }

        paintPrices({ avgWarehouseSystem, avgSystemAllWarehouses, lastTxPrice });
      }

      /* ───────────── TABLA 2: STOCK POR ALMACÉN ───────────── */
      function fmtInt(n){
        const x = Number(n);
        return Number.isFinite(x) ? String(Math.trunc(x)) : '-';
      }

      function paintStockTable(stockRows, selectedWarehouseId){
        stockTbody.innerHTML = '';

        if (!stockRows || !stockRows.length){
          stockTbody.innerHTML = `<tr><td class="rev-mini-k">Sin datos.</td><td class="rev-mini-v">-</td></tr>`;
          return;
        }

        stockRows.forEach(r => {
          const tr = document.createElement('tr');
          if (selectedWarehouseId && r.warehouse_id === selectedWarehouseId){
            tr.style.fontWeight = '700';
          }
          tr.innerHTML = `
            <td class="rev-mini-k">${r.warehouse_name}</td>
            <td class="rev-mini-v">${fmtInt(r.stock)} SCU</td>
          `;
          stockTbody.appendChild(tr);
        });
      }

      async function loadStockByWarehousesForItem(itemId){
        const { data, error } = await supa
          .from('warehouse_items')
          .select('warehouse_id, quantity')
          .eq('commodity_id', itemId);

        if (error) {
          console.error('Error cargando stock por almacén:', error);
          return [];
        }

        const qtyByWh = {};
        (data || []).forEach(x => { qtyByWh[x.warehouse_id] = Number(x.quantity || 0); });

        return (warehouses || []).map(w => ({
          warehouse_id: w.id,
          warehouse_name: w.name || 'Almacén',
          stock: qtyByWh[w.id] ?? 0
        }));
      }

      function isInsufficientStock({ requestType, requestedQty, selectedWarehouseId, stockRows }){
        if (requestType !== 'compra') return false;
        if (!selectedWarehouseId) return false;

        const row = stockRows.find(r => r.warehouse_id === selectedWarehouseId);
        const available = Number(row?.stock ?? 0);
        const needed = Number(requestedQty ?? 0);

        return Number.isFinite(needed) && needed > available;
      }

      /* ───── modal open/close ───── */
      let pendingRequests = [];
      let currentRequest  = null;
      let cachedStockRows = [];

      async function openModalForRequest(r, itemName, requesterName) {
        currentRequest = r;

        revType.value      = renderTipo(r.request_type);
        revRequester.value = requesterName || '';
        revItem.value      = itemName || '';
        revQty.value       = r.quantity ?? '';

        const preferredName = r.preferred_warehouse_id
          ? (warehousesById[r.preferred_warehouse_id]?.name || ('ID ' + r.preferred_warehouse_id))
          : 'Sin preferencia registrada';

        revPreferred.value = preferredName;

        warehouseSelect.value = '';

        // Tabla 1: precios
        priceTbody.innerHTML = `<tr><td class="rev-mini-k">Selecciona un almacén.</td><td class="rev-mini-v">-</td></tr>`;

        // Tabla 2: stock (carga por item)
        stockTbody.innerHTML = `<tr><td class="rev-mini-k">Cargando...</td><td class="rev-mini-v">-</td></tr>`;
        cachedStockRows = await loadStockByWarehousesForItem(r.item_id);
        paintStockTable(cachedStockRows, '');

        // Alerta oculta por defecto
        showInsufficientStockAlert(false);

        setDefaultDueDatePlusDays(7);
        modalBackdrop.style.display = 'flex';
      }

      function closeModal() {
        modalBackdrop.style.display = 'none';
        currentRequest = null;
        cachedStockRows = [];
      }

      revCancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
      modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });

      warehouseSelect.addEventListener('change', async () => {
        if (!currentRequest) return;

        const warehouseId = warehouseSelect.value || '';

        // Tabla 1 (precios)
        await loadPricingForItem(currentRequest.item_id, warehouseId);

        // Tabla 2 (stock) + highlight almacén seleccionado
        paintStockTable(cachedStockRows, warehouseId);

        // Alerta ALR-02: solo compra y si no hay stock
        const insufficient = isInsufficientStock({
          requestType: currentRequest.request_type,
          requestedQty: currentRequest.quantity,
          selectedWarehouseId: warehouseId,
          stockRows: cachedStockRows
        });
        showInsufficientStockAlert(insufficient);
      });

      /* ───── 5) Carga solicitudes pendientes ───── */
      async function loadPendingRequests() {
        const { data, error } = await supa
          .from('requests')
          .select(`
            id,
            request_type,
            item_id,
            quantity,
            status,
            created_at,
            due_date,
            requester_discord_id,
            preferred_warehouse_id,
            commodities_master(name, symbol)
          `)
          .eq('status', 'pendiente')
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error cargando solicitudes pendientes:', error);
          return;
        }

        pendingRequests = data || [];
        renderTable();
      }

      function renderTable() {
        tbody.innerHTML = '';
        const term = (searchInput.value || '').toLowerCase();

        if (!pendingRequests.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 9;
          td.textContent = 'No hay solicitudes pendientes de revisión.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        pendingRequests.forEach(r => {
          const cm = r.commodities_master;
          const itemName = cm
            ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
            : (r.item_id || '');

          const user = usersById[r.requester_discord_id];
          const requesterName = user?.handle_name || user?.discord_username || r.requester_discord_id;

          if (term) {
            const haystack = (itemName + ' ' + requesterName).toLowerCase();
            if (!haystack.includes(term)) return;
          }

          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>#${r.id}</td>
            <td><span class="${tipoTagClass(r.request_type)}">${renderTipo(r.request_type)}</span></td>
            <td>${itemName}</td>
            <td>${r.quantity}</td>
            <td>${requesterName}</td>
            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</td>
            <td><span class="${statusTagClass(r.status || 'pendiente')}">${formatStatus(r.status || 'pendiente')}</span></td>
          `;

          const tdDetalle = document.createElement('td');
          const btnDetalle = document.createElement('button');
          btnDetalle.type = 'button';
          btnDetalle.className = 'btn btn-secondary btn-sm';
          btnDetalle.textContent = 'Ver';
          btnDetalle.addEventListener('click', (ev) => {
            ev.stopPropagation();
            window.open(`./solicitud_detalle.html?id=${encodeURIComponent(r.id)}`, '_blank', 'width=720,height=760');
          });
          tdDetalle.appendChild(btnDetalle);
          tr.appendChild(tdDetalle);

          const tdAcc = document.createElement('td');
          const canAct = !readOnly;

          const okBtn = document.createElement('button');
          okBtn.type = 'button';
          okBtn.className = 'btn-icon ok';
          okBtn.innerHTML = '✔';
          okBtn.disabled = !canAct;
          if (!canAct) okBtn.classList.add('btn-disabled');
          okBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;
            await openModalForRequest(r, itemName, requesterName);
          });

          const koBtn = document.createElement('button');
          koBtn.type = 'button';
          koBtn.className = 'btn-icon ko';
          koBtn.style.marginLeft = '0.25rem';
          koBtn.innerHTML = '✕';
          koBtn.disabled = !canAct;
          if (!canAct) koBtn.classList.add('btn-disabled');
          koBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;

            const okConfirm = confirm('¿Seguro que quieres rechazar esta solicitud?\nEsta acción no se puede deshacer.');
            if (!okConfirm) return;

            const { error } = await supa
              .from('requests')
              .update({
                status: 'rechazada',
                approver_discord_id: session.user.id
              })
              .eq('id', r.id);

            if (error) {
              console.error('Error rechazando solicitud:', error);
              alert('No se ha podido rechazar la solicitud.');
              return;
            }

            if (r.requester_discord_id) {
              await supa.from('notifications').insert({
                user_id: r.requester_discord_id,
                type: 'request_rejected',
                title: `Solicitud #${r.id} rechazada`,
                body: 'Tesoro ha rechazado tu solicitud en la fase de revisión.',
                link_url: `./solicitud_detalle.html?id=${encodeURIComponent(r.id)}`,
                related_request_id: r.id,
                level: 'danger'
              });
            }

            await loadPendingRequests();
          });

          tdAcc.appendChild(okBtn);
          tdAcc.appendChild(koBtn);
          tr.appendChild(tdAcc);

          tbody.appendChild(tr);
        });

        if (!tbody.children.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 9;
          td.textContent = 'No hay resultados con ese filtro.';
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      }

      searchInput.addEventListener('input', renderTable);

      /* ───── 6) Aprobar ───── */
      revForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (readOnly) { alert('Tienes permisos de solo lectura en este módulo.'); return; }
        if (!currentRequest) return;

        const warehouseId = warehouseSelect.value;
        if (!warehouseId) { alert('Debes seleccionar un almacén.'); return; }
        if (!selectedDueDate) { alert('Debes seleccionar una fecha límite de entrega.'); return; }

        const dueDate = selectedDueDate.toISOString().split('T')[0];

        const { error } = await supa
          .from('requests')
          .update({
            status: 'aprobada',
            warehouse_id: warehouseId,
            due_date: dueDate,
            approved_at: new Date().toISOString(),
            approver_discord_id: session.user.id
          })
          .eq('id', currentRequest.id);

        if (error) {
          console.error('Error aprobando solicitud:', error);
          alert('No se ha podido aprobar la solicitud.');
          return;
        }

        if (currentRequest.requester_discord_id) {
          await supa.from('notifications').insert({
            user_id: currentRequest.requester_discord_id,
            type: 'request_approved',
            title: `Solicitud #${currentRequest.id} aprobada`,
            body: `Tesoro ha aprobado tu solicitud. Plazo máx.: ${dueDate}.`,
            link_url: `./solicitud_detalle.html?id=${encodeURIComponent(currentRequest.id)}`,
            related_request_id: currentRequest.id,
            level: 'info'
          });
        }

        closeModal();
        await loadPendingRequests();
      });

      await loadPendingRequests();
    });
  </script>
</body>
</html>
