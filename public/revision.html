<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Revisión de solicitudes</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    main.rev-main {
      padding: 1.5rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .btn {
      padding: 0.35rem 0.85rem;
      border-radius: 0.4rem;
      border: none;
      cursor: pointer;
      font-size: .85rem;
    }
    .btn-primary {
      background: #22c55e;
      color: #020617;
      font-weight: 600;
    }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.8);
    }
    .btn-disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
      color: #e5e7eb;
      font-size: .8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      cursor: pointer;
    }
    .btn-icon.ok {
      background: #22c55e;
      color: #022c22;
      border-color: #22c55e;
    }
    .btn-icon.ko {
      background: #ef4444;
      color: #fef2f2;
      border-color: #ef4444;
    }
    .btn-icon:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .help-text {
      font-size:.75rem;
      opacity:.75;
      margin-top:.15rem;
    }

    .rev-table {
      width:100%;
      border-collapse:collapse;
      font-size:.9rem;
    }
    .rev-table thead {
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.8;
    }
    .rev-table th,
    .rev-table td {
      padding:0.35rem 0.45rem;
      border-bottom:1px solid rgba(148,163,184,0.3);
    }
    .rev-table tbody tr {
      transition:background .12s ease-out;
    }
    .rev-table tbody tr:hover {
      background:rgba(15,23,42,0.9);
    }

    .tipo-chip {
      display:inline-block;
      padding:0.08rem 0.45rem;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(148,163,184,0.9);
      margin-left:.25rem;
      opacity:.85;
    }
    .tipo-chip.compra { border-color: rgba(34,197,94,0.9); }
    .tipo-chip.venta  { border-color: rgba(248,113,113,0.9); }

    .badge-status {
      display:inline-flex;
      align-items:center;
      padding:0.1rem 0.55rem;
      border-radius:999px;
      font-size:.75rem;
      border:1px solid rgba(148,163,184,0.7);
    }
    .badge-status.pendiente   { border-color: rgba(250,204,21,0.9); }
    .badge-status.aprobada    { border-color: rgba(34,197,94,0.9); }
    .badge-status.rechazada   { border-color: rgba(248,113,113,0.9); }
    .badge-status.completada  { border-color: rgba(56,189,248,0.9); }
    .badge-status.cancelada   { border-color: rgba(248,113,113,0.9); }

    .rev-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.6rem;
      flex-wrap:wrap;
      margin-bottom:.6rem;
    }
    .rev-toolbar-group {
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .rev-toolbar input[type="search"] {
      padding:0.35rem 0.55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:#020617;
      color:#e5e7eb;
      font-size:.8rem;
    }

    /* Modal aprobación */
    .rev-modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .rev-modal {
      background:#020617;
      border-radius:0.9rem;
      padding:1.1rem 1.3rem 0.9rem;
      max-width:820px; /* <-- ensanchado para la tabla */
      width:100%;
      box-shadow:0 18px 40px rgba(0,0,0,0.75);
    }
    .rev-form .field {
      margin-bottom:.8rem;
    }
    .rev-form label {
      display:block;
      font-size:.8rem;
      opacity:.8;
      margin-bottom:.25rem;
    }
    .rev-form input,
    .rev-form select,
    .rev-form textarea {
      width:100%;
      padding:0.4rem 0.55rem;
      border-radius:0.5rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.9rem;
    }
    .rev-form textarea {
      min-height:100px;
      resize:vertical;
    }
    .rev-modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      margin-top:.7rem;
      flex-wrap:wrap;
    }

    .rev-grid-2 {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.75rem;
    }

    .rev-bottom-grid {
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.8fr);
      gap:.9rem;
      margin-top:.25rem;
    }

    @media (max-width: 840px) {
      .rev-bottom-grid {
        grid-template-columns:minmax(0,1fr);
      }
    }

    /* Contenedor calendario inline centrado */
    #rev-calendar-container {
      display:flex;
      justify-content:center;
      margin-top:.2rem;
    }

    /* Lista stock */
    .rev-stock-list {
      border-radius:0.5rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      padding:0.35rem 0.5rem;
      max-height:260px;
      overflow:auto;
      font-size:.8rem;
    }
    .rev-stock-table {
      width:100%;
      border-collapse:collapse;
      font-size:.8rem;
    }
    .rev-stock-table th,
    .rev-stock-table td {
      padding:0.2rem 0.25rem;
      border-bottom:1px solid rgba(148,163,184,0.25);
    }
    .rev-stock-table thead {
      text-transform:uppercase;
      letter-spacing:.04em;
      opacity:.8;
    }
    .rev-stock-table th:nth-child(2),
    .rev-stock-table th:nth-child(3),
    .rev-stock-table th:nth-child(4),
    .rev-stock-table th:nth-child(5),
    .rev-stock-table td:nth-child(2),
    .rev-stock-table td:nth-child(3),
    .rev-stock-table td:nth-child(4),
    .rev-stock-table td:nth-child(5) {
      text-align:right;
      white-space:nowrap;
    }

    /* ─────────── THEME DARK PARA FLATPICKR ─────────── */

    .flatpickr-calendar {
      background:#020617;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
      border-radius:0.75rem;
      color:#e5e7eb;
      font-size:0.8rem;
    }

    .flatpickr-months {
      background:#020617;
      border-bottom:1px solid rgba(148,163,184,0.4);
    }

    .flatpickr-months .flatpickr-month {
      color:#e5e7eb;
      fill:#e5e7eb;
    }

    .flatpickr-current-month {
      font-size:0.9rem;
      padding-top:0.3rem;
      padding-bottom:0.3rem;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
      background:transparent;
      color:#e5e7eb;
      font-weight:500;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months:hover,
    .flatpickr-current-month input.cur-year:hover {
      background:rgba(15,23,42,0.9);
    }

    .flatpickr-weekdays {
      background:#020617;
      color:#9ca3af;
      font-size:0.75rem;
    }

    .flatpickr-weekday {
      color:#9ca3af;
    }

    .flatpickr-day {
      color:#e5e7eb;
      border-radius:0.4rem;
    }

    .flatpickr-day:hover {
      background:#1e293b;
      border-color:#1e293b;
    }

    .flatpickr-day.today {
      border-color:#38bdf8;
      color:#e0f2fe;
    }

    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
      background:#22c55e;
      border-color:#22c55e;
      color:#022c22;
    }

    .flatpickr-day.disabled,
    .flatpickr-day.disabled:hover {
      color:#4b5563;
      background:transparent;
      border-color:transparent;
      cursor:not-allowed;
    }

    .flatpickr-prev-month,
    .flatpickr-next-month {
      color:#e5e7eb;
      fill:#e5e7eb;
    }

    .flatpickr-prev-month:hover,
    .flatpickr-next-month:hover {
      background:#0f172a;
    }

    .flatpickr-innerContainer {
      background:#020617;
    }

    .flatpickr-rContainer {
      background:#020617;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="rev-main">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:.75rem;flex-wrap:wrap;">
      <div>
        <h2>Revisión de solicitudes</h2>
        <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
          Aprueba o rechaza las solicitudes pendientes del Tesoro.
        </p>
      </div>
      <button type="button"
              class="btn btn-secondary"
              onclick="window.location.href='./app_ui.html'">
        ← Volver al panel
      </button>
    </div>

    <div class="card" style="padding:1rem 1.2rem;">
      <div class="rev-toolbar">
        <div class="rev-toolbar-group">
          <strong style="font-size:.85rem;">Solicitudes pendientes</strong>
          <span class="help-text">
            Solo se muestran solicitudes en estado <b>pendiente</b>.
          </span>
        </div>
        <div class="rev-toolbar-group">
          <input type="search" id="rev-search" placeholder="Buscar por ítem o solicitante..."/>
        </div>
      </div>

      <div style="max-height:460px;overflow:auto;">
        <table class="rev-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>Ítem</th>
              <th>Cant.</th>
              <th>Solicitante</th>
              <th>Creada</th>
              <th>Estado</th>
              <th>Detalle</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="rev-tbody">
            <!-- filas JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAL APROBAR SOLICITUD -->
  <div id="rev-modal-backdrop" class="rev-modal-backdrop" style="display:none;">
    <div class="rev-modal">
      <h3 style="margin-top:0;margin-bottom:.6rem;">Aprobar solicitud</h3>
      <form id="rev-form" class="rev-form">

        <!-- Resumen desglosado -->
        <div class="rev-grid-2">
          <div class="field">
            <label>Tipo de solicitud</label>
            <input id="rev-type" type="text" readonly>
          </div>
          <div class="field">
            <label>Solicitante</label>
            <input id="rev-requester" type="text" readonly>
          </div>
        </div>

        <div class="rev-grid-2">
          <div class="field">
            <label>Ítem</label>
            <input id="rev-item" type="text" readonly>
          </div>
          <div class="field">
            <label>Cantidad</label>
            <input id="rev-qty" type="text" readonly>
          </div>
        </div>

        <div class="field">
          <label>Preferencia de lugar de entrega</label>
          <input id="rev-preferred" type="text" readonly>
        </div>

        <!-- Selección de almacén -->
        <div class="field">
          <label>Almacén / Lugar de transacción</label>
          <select id="rev-warehouse-select" required>
            <option value="">Selecciona un almacén...</option>
          </select>
        </div>

        <!-- Fecha + stock en 2 columnas -->
        <div class="rev-bottom-grid">
          <div class="field">
            <label>Fecha límite de entrega</label>
            <div id="rev-calendar-container">
              <div id="rev-calendar"></div>
            </div>
          </div>

          <div class="field">
            <label>Stock por almacén para este ítem</label>
            <div id="rev-stock-list" class="rev-stock-list">
              <!-- tabla JS -->
            </div>
          </div>
        </div>

        <div class="rev-modal-actions">
          <button type="button" id="rev-cancel" class="btn btn-secondary">
            Cancelar
          </button>
          <button type="submit" id="rev-approve" class="btn btn-primary">
            Aprobar solicitud
          </button>
        </div>
      </form>
      <p class="help-text" style="margin-top:.5rem;">
        Una vez aprobada o rechazada, la decisión no se puede deshacer desde la aplicación.
      </p>
    </div>
  </div>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      function formatStatus(st) {
        const map = {
          pendiente: 'pendiente',
          aprobada: 'aprobada',
          rechazada: 'rechazada',
          completada: 'completada',
          cancelada: 'cancelada'
        };
        return map[st] || st;
      }

      function renderTipo(tipo) {
        if (!tipo) return '-';
        return tipo === 'compra' ? 'Compra' : 'Venta';
      }

      /* ───── 1) Sesión + org_status ───── */
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = './index.html';
        return;
      }

      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      if (typeof window.loadHeader === 'function') {
        await window.loadHeader('app');
      }
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => {
            await supa.auth.signOut();
            window.location.href = "./index.html";
          },
          () => window.location.href = './perfil.html'
        );
      }

      /* ───── 2) Permisos módulo revisión ───── */
      const { data: meRow, error: meError } = await supa
        .from('users')
        .select('tesoro_internal_role')
        .eq('id', session.user.id)
        .maybeSingle();

      if (meError) console.error('Error leyendo rol interno:', meError);

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === 'string') myRole = myRole.trim();

      let roleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber) && myRole !== '') {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .eq('id', asNumber)
            .maybeSingle();
          if (!error) roleRow = data;
        }
        if (!roleRow) {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .ilike('role_name', myRole)
            .maybeSingle();
          if (!error) roleRow = data;
        }
      }

      let revLevel = roleRow?.revision ?? 0;
      if (!revLevel || revLevel === 0) {
        alert('No tienes acceso al módulo de Revisión.');
        window.location.href = './app_ui.html';
        return;
      }
      const readOnly = (revLevel === 1);

      /* ───── 3) Datos auxiliares: usuarios + almacenes ───── */
      const usersById = {};
      const { data: users, error: usersError } = await supa
        .from('users')
        .select('id, handle_name, discord_username');
      if (!usersError && users) {
        users.forEach(u => { usersById[u.id] = u; });
      }

      const warehousesById = {};
      const { data: warehouses, error: whError } = await supa
        .from('warehouses')
        .select('id, name')
        .order('name', { ascending: true });
      if (whError) console.error('Error cargando almacenes:', whError);

      (warehouses || []).forEach(w => { warehousesById[w.id] = w; });

      /* Rellenar select del modal */
      const warehouseSelect = document.getElementById('rev-warehouse-select');
      (warehouses || []).forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.id;
        opt.textContent = w.name || 'Almacén';
        warehouseSelect.appendChild(opt);
      });

      /* ───── 4) DOM tabla + modal ───── */
      const tbody         = document.getElementById('rev-tbody');
      const searchInput   = document.getElementById('rev-search');

      const modalBackdrop = document.getElementById('rev-modal-backdrop');
      const revForm       = document.getElementById('rev-form');
      const revCancelBtn  = document.getElementById('rev-cancel');

      const revType       = document.getElementById('rev-type');
      const revRequester  = document.getElementById('rev-requester');
      const revItem       = document.getElementById('rev-item');
      const revQty        = document.getElementById('rev-qty');
      const revPreferred  = document.getElementById('rev-preferred');
      const revStockList  = document.getElementById('rev-stock-list');

      const calendarElem  = document.getElementById('rev-calendar');
      let dueDatePicker   = null;
      let selectedDueDate = null;

      function initCalendar() {
        const today = new Date();
        const defaultDate = new Date();
        defaultDate.setDate(today.getDate() + 7);

        if (dueDatePicker) dueDatePicker.destroy();

        dueDatePicker = flatpickr(calendarElem, {
          inline: true,
          dateFormat: "Y-m-d",
          minDate: "today",
          defaultDate,
          disableMobile: true,
          onChange(selectedDates) {
            selectedDueDate = selectedDates[0] || null;
          }
        });

        selectedDueDate = defaultDate;
      }

      initCalendar();

      // Stock por almacén para el ítem
      async function loadStockForItem(itemId) {
        if (!itemId) {
          revStockList.textContent = 'Ítem no reconocido.';
          return;
        }

        revStockList.textContent = 'Cargando stock...';

        const { data, error } = await supa
          .from('warehouse_items')
          .select(`
            warehouse_id,
            quantity,
            warehouses(name)
          `)
          .eq('commodity_id', itemId)
          .order('warehouses(name)', { ascending: true });

        if (error) {
          console.error('Error cargando stock por almacén:', error);
          revStockList.textContent = 'No se ha podido cargar el stock de los almacenes.';
          return;
        }

        const rows = data || [];
        if (!rows.length) {
          revStockList.textContent = 'No hay stock registrado para este ítem en ningún almacén.';
          return;
        }

        const table = document.createElement('table');
        table.className = 'rev-stock-table';

        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>ALMACÉN</th>
            <th>CANT.</th>
            <th>ÚLT. SCU</th>
            <th>MEDIA ALM.</th>
            <th>MEDIA SIST.</th>
          </tr>`;
        table.appendChild(thead);

        const tbodyEl = document.createElement('tbody');

        rows.forEach(r => {
          const tr = document.createElement('tr');
          const wName = r.warehouses?.name || warehousesById[r.warehouse_id]?.name || r.warehouse_id;

          const tdName = document.createElement('td');
          tdName.textContent = wName || '-';

          const tdQty = document.createElement('td');
          tdQty.textContent = Number(r.quantity || 0);

          const tdLast = document.createElement('td');
          const tdAvgW = document.createElement('td');
          const tdAvgS = document.createElement('td');

          // De momento no tenemos datos → vacío
          tdLast.textContent = '-';
          tdAvgW.textContent = '-';
          tdAvgS.textContent = '-';

          tr.appendChild(tdName);
          tr.appendChild(tdQty);
          tr.appendChild(tdLast);
          tr.appendChild(tdAvgW);
          tr.appendChild(tdAvgS);

          tbodyEl.appendChild(tr);
        });

        table.appendChild(tbodyEl);

        revStockList.innerHTML = '';
        revStockList.appendChild(table);
      }

      let pendingRequests = [];
      let currentRequest  = null;

      async function openModalForRequest(r, itemName, requesterName) {
        currentRequest = r;

        revType.value      = renderTipo(r.request_type);
        revRequester.value = requesterName || '';
        revItem.value      = itemName || '';
        revQty.value       = r.quantity ?? '';

        const preferredName = r.preferred_warehouse_id
          ? (warehousesById[r.preferred_warehouse_id]?.name || 'Sin nombre (ID ' + r.preferred_warehouse_id + ')')
          : 'Sin preferencia registrada';

        revPreferred.value = preferredName;

        warehouseSelect.value = '';

        initCalendar();
        await loadStockForItem(r.item_id);

        modalBackdrop.style.display = 'flex';
      }

      function closeModal() {
        modalBackdrop.style.display = 'none';
        currentRequest = null;
      }

      revCancelBtn.addEventListener('click', (e) => {
        e.preventDefault();
        closeModal();
      });

      modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) closeModal();
      });

      /* ───── 5) Carga de solicitudes pendientes ───── */
      async function loadPendingRequests() {
        const { data, error } = await supa
          .from('requests')
          .select(`
            id,
            request_type,
            item_id,
            quantity,
            status,
            created_at,
            due_date,
            requester_discord_id,
            preferred_warehouse_id,
            commodities_master(name, symbol)
          `)
          .eq('status', 'pendiente')
          .order('created_at', { ascending: true });

        if (error) {
          console.error('Error cargando solicitudes pendientes:', error);
          return;
        }

        pendingRequests = data || [];
        renderTable();
      }

      function renderTable() {
        tbody.innerHTML = '';

        const term = (searchInput.value || '').toLowerCase();

        if (!pendingRequests.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 9;
          td.textContent = 'No hay solicitudes pendientes de revisión.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        pendingRequests.forEach(r => {
          const cm = r.commodities_master;
          const itemName = cm
            ? (cm.symbol ? `${cm.name} (${cm.symbol})` : cm.name)
            : (r.item_id || '');

          const user = usersById[r.requester_discord_id];
          const requesterName = user?.handle_name || user?.discord_username || r.requester_discord_id;

          if (term) {
            const haystack = (itemName + ' ' + requesterName).toLowerCase();
            if (!haystack.includes(term)) return;
          }

          const tr = document.createElement('tr');

          const tdId = document.createElement('td');
          tdId.textContent = `#${r.id}`;

          const tdTipo = document.createElement('td');
          tdTipo.innerHTML = `<span class="tipo-chip ${r.request_type}">${renderTipo(r.request_type)}</span>`;

          const tdItem = document.createElement('td');
          tdItem.textContent = itemName;

          const tdQty = document.createElement('td');
          tdQty.textContent = r.quantity;

          const tdReq = document.createElement('td');
          tdReq.textContent = requesterName;

          const tdCreated = document.createElement('td');
          tdCreated.textContent = r.created_at
            ? new Date(r.created_at).toLocaleString()
            : '-';

          const tdStatus = document.createElement('td');
          const statusSpan = document.createElement('span');
          statusSpan.className = 'badge-status ' + (r.status || 'pendiente');
          statusSpan.textContent = formatStatus(r.status || 'pendiente');
          tdStatus.appendChild(statusSpan);

          const tdDetalle = document.createElement('td');
          const btnDetalle = document.createElement('button');
          btnDetalle.type = 'button';
          btnDetalle.className = 'btn btn-secondary';
          btnDetalle.style.padding = '0.2rem 0.6rem';
          btnDetalle.textContent = 'Ver';
          btnDetalle.addEventListener('click', (ev) => {
            ev.stopPropagation();
            window.open(
              `./solicitud_detalle.html?id=${encodeURIComponent(r.id)}`,
              '_blank',
              'width=720,height=760'
            );
          });
          tdDetalle.appendChild(btnDetalle);

          const tdAcc = document.createElement('td');
          const canAct = !readOnly;

          const okBtn = document.createElement('button');
          okBtn.type = 'button';
          okBtn.className = 'btn-icon ok';
          okBtn.innerHTML = '✔';
          okBtn.disabled = !canAct;
          if (!canAct) okBtn.classList.add('btn-disabled');
          okBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;
            await openModalForRequest(r, itemName, requesterName);
          });

          const koBtn = document.createElement('button');
          koBtn.type = 'button';
          koBtn.className = 'btn-icon ko';
          koBtn.style.marginLeft = '0.25rem';
          koBtn.innerHTML = '✕';
          koBtn.disabled = !canAct;
          if (!canAct) koBtn.classList.add('btn-disabled');
          koBtn.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!canAct) return;

            const okConfirm = confirm(
              '¿Seguro que quieres rechazar esta solicitud?\n' +
              'Esta acción no se puede deshacer.'
            );
            if (!okConfirm) return;

            const { error } = await supa
              .from('requests')
              .update({
                status: 'rechazada',
                approver_discord_id: session.user.id
              })
              .eq('id', r.id);

            if (error) {
              console.error('Error rechazando solicitud:', error);
              alert('No se ha podido rechazar la solicitud.');
              return;
            }

            // Notificación al solicitante: solicitud rechazada
            if (r.requester_discord_id) {
              await supa.from('notifications').insert({
                user_id: r.requester_discord_id,
                type: 'request_rejected',
                title: `Solicitud #${r.id} rechazada`,
                body: 'Tesoro ha rechazado tu solicitud en la fase de revisión.',
                link_url: `./solicitud_detalle.html?id=${encodeURIComponent(r.id)}`,
                related_request_id: r.id,
                level: 'danger'
              });
            }

            await loadPendingRequests();
          });

          tdAcc.appendChild(okBtn);
          tdAcc.appendChild(koBtn);

          tr.appendChild(tdId);
          tr.appendChild(tdTipo);
          tr.appendChild(tdItem);
          tr.appendChild(tdQty);
          tr.appendChild(tdReq);
          tr.appendChild(tdCreated);
          tr.appendChild(tdStatus);
          tr.appendChild(tdDetalle);
          tr.appendChild(tdAcc);

          tbody.appendChild(tr);
        });
      }

      searchInput.addEventListener('input', renderTable);

      /* ───── 6) Envío del formulario de aprobación ───── */
      revForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (readOnly) {
          alert('Tienes permisos de solo lectura en este módulo.');
          return;
        }
        if (!currentRequest) return;

        const warehouseId = warehouseSelect.value;

        if (!warehouseId) {
          alert('Debes seleccionar un almacén.');
          return;
        }
        if (!selectedDueDate) {
          alert('Debes seleccionar una fecha límite de entrega.');
          return;
        }

        const dueDate = selectedDueDate.toISOString().split('T')[0];

        const { error } = await supa
          .from('requests')
          .update({
            status: 'aprobada',
            warehouse_id: warehouseId,
            due_date: dueDate,
            approved_at: new Date().toISOString(),
            approver_discord_id: session.user.id
          })
          .eq('id', currentRequest.id);

        if (error) {
          console.error('Error aprobando solicitud:', error);
          alert('No se ha podido aprobar la solicitud.');
          return;
        }

        // Notificación al solicitante: solicitud aprobada
        if (currentRequest.requester_discord_id) {
          await supa.from('notifications').insert({
            user_id: currentRequest.requester_discord_id,
            type: 'request_approved',
            title: `Solicitud #${currentRequest.id} aprobada`,
            body: `Tesoro ha aprobado tu solicitud. Plazo máx.: ${dueDate}.`,
            link_url: `./solicitud_detalle.html?id=${encodeURIComponent(currentRequest.id)}`,
            related_request_id: currentRequest.id,
            level: 'info'
          });
        }

        closeModal();
        await loadPendingRequests();
      });

      /* ───── 7) Carga inicial ───── */
      await loadPendingRequests();
    });
  </script>
</body>
</html>
