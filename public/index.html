<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventario ‚Äî Login</title>
  <link rel="stylesheet" href="./style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/auth.js" defer></script>
  <script src="./modules/layout.js" defer></script>
  <script src="./app.js" defer></script>
</head>
<body>
  <div id="site-header"></div>
  <main>
    <div class="card">
      <h2>Accede con Discord</h2>
      <p>Consulta el stock, crea peticiones y, si tienes rol de encargado, revisa solicitudes.</p>
      <div class="row">
        <button id="login-discord">Entrar con Discord</button>
        <a href="./app_ui.html"><button id="go-app">Entrar como invitado (solo lectura)</button></a>
      </div>
      <p style="opacity:.7;margin-top:.75rem">El acceso de invitado muestra el inventario p√∫blico (demo).</p>
    </div>
  </main>

  <!-- üëá A√±ade este script justo antes de cerrar body -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Espera a que el cliente Supabase est√© listo
      const { data: { session } } = await window.supa.auth.getSession();

      // Si ya existe una sesi√≥n activa (el usuario ya ha hecho login antes)
      if (session) {
        // Redirige directamente al panel principal
        window.location.href = "./app_ui.html";
      }
    });
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Cargamos header en modo "public" (sin avatar/men√∫)
    await loadHeader('public');

    // Redirigir al panel si ya hay sesi√≥n
    const { data: { session } } = await window.supa.auth.getSession();
    if (session) {
      window.location.href = "./app_ui.html";
    }
  });
</script>
<script type="module">
  import { ensureProfile, getOrgStatus } from './modules/profile.js';

  const BOT_URL = 'https://juvhyzjjtwfokgnrnejv.supabase.co/functions/v1/check-discord-member';

  async function callBotCheck(discord_user_id) {
    const res = await fetch(BOT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ discord_user_id })
    });

    if (!res.ok) {
      console.error('HTTP error en check-discord-member', res.status);
      return { allowed: false, reason: 'BOT_HTTP_ERROR' };
    }

    return await res.json();
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const { supa } = window;

    const { data: { session } } = await supa.auth.getSession();
    if (!session) return; // todav√≠a no ha hecho login

    // 1) Crear/actualizar fila en public.users
    const profile = await ensureProfile();
    if (!profile || !profile.discord_user_id) {
      await supa.auth.signOut();
      alert('No se ha podido obtener tu perfil de Discord.');
      return;
    }

    // 2) Preguntar al bot (Edge Function) -> ¬øest√° en la guild? ¬øroles?
    const botResult = await callBotCheck(profile.discord_user_id);
    console.log('check-discord-member:', botResult);

    if (!botResult.allowed) {
      await supa.auth.signOut();
      alert('No eres miembro de la organizaci√≥n o no tienes un rol v√°lido.\nMotivo: ' + (botResult.reason || 'desconocido'));
      return;
    }

    // 3) Doble check leyendo org_status de la BD
    const status = await getOrgStatus();
    if (!status || !['miembro','daga','espada','admin'].includes(status)) {
      await supa.auth.signOut();
      alert('Tu acceso al Tesoro todav√≠a no est√° activado. (org_status=' + status + ')');
      return;
    }

    // 4) Si ha pasado todo, puede entrar al panel
    window.location.href = './app_ui.html';
  });
</script>

</body>
</html>
