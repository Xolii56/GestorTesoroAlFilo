<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tesoro — Detalle de usuario</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.user-detail-main {
      padding: 1rem;
      max-width: 720px;
      margin: 0 auto;
    }

    .user-form .field {
      margin-bottom:.7rem;
    }
    .user-form label {
      display:block;
      font-size:.8rem;
      opacity:.8;
      margin-bottom:.2rem;
    }
    .user-form input,
    .user-form select {
      width:100%;
      padding:0.4rem 0.5rem;
      border-radius:0.4rem;
      border:1px solid rgba(148,163,184,0.8);
      background:#020617;
      color:#e5e7eb;
      font-size:.9rem;
    }
    .user-form input[readonly],
    .user-form select[disabled] {
      opacity:.8;
      cursor:not-allowed;
    }

    .btn {
      padding:0.35rem 0.85rem;
      border-radius:0.4rem;
      border:none;
      cursor:pointer;
      font-size:.85rem;
    }
    .btn-secondary {
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.8);
    }
    .btn-primary {
      background:#22c55e;
      color:#020617;
      font-weight:600;
    }
    .btn-disabled {
      opacity:.6;
      cursor:not-allowed;
    }

    .help-text {
      font-size:.75rem;
      opacity:.75;
      margin-top:.15rem;
    }

    .user-actions {
      display:flex;
      justify-content:flex-end;
      gap:.5rem;
      margin-top:.6rem;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <main class="user-detail-main">
    <div class="card" style="padding:1rem 1.1rem;">
      <h2 style="margin-top:0;margin-bottom:.4rem;">Detalle de usuario</h2>
      <p class="help-text" id="user-perms-label"></p>

      <form id="user-form" class="user-form">
        <div class="field">
          <label>Handle en la app</label>
          <input id="u_handle" type="text"/>
          <p class="help-text">
            Alias mostrado dentro de la herramienta.
          </p>
        </div>

        <div class="field">
          <label>Usuario de Discord</label>
          <input id="u_discord" type="text" readonly/>
        </div>

        <div class="field">
          <label>Rol interno del Tesoro</label>
          <select id="u_role_internal"></select>
          <p class="help-text">
            Controla permisos sobre módulos (según tabla <b>roles_app</b>).
            No puedes cambiar tu propio rol desde aquí.
          </p>
        </div>

        <div class="field">
          <label>Estado en la organización (org_status)</label>
          <!-- AHORA ES UN SELECT CON OPCIONES DE public.discord_roles -->
          <select id="u_org_status"></select>
          <p class="help-text">
            Valores basados en <b>public.discord_roles.mapped_org_status</b> (Miembro, Daga, Espada, Afiliado, etc.).
            No puedes cambiar tu propio estado desde aquí.
          </p>
        </div>

        <div class="field">
          <label>Fecha de alta</label>
          <input id="u_created" type="text" readonly/>
        </div>

        <div class="field">
          <label>Último login</label>
          <input id="u_last_login" type="text" readonly/>
        </div>

        <div class="user-actions">
          <button type="button" class="btn btn-secondary" id="btn-close">
            Cerrar
          </button>
          <button type="submit" class="btn btn-primary" id="btn-save">
            Guardar cambios
          </button>
        </div>
      </form>
    </div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';

    function cleanDiscordUsername(raw) {
      if (!raw) return '';
      return raw.endsWith('#0') ? raw.slice(0, -2) : raw;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // Parsear ?id=...
      const params = new URLSearchParams(window.location.search);
      const userId = params.get('id');
      if (!userId) {
        alert('No se ha indicado el usuario a consultar.');
        window.close();
        return;
      }

      // Sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        alert('Sesión no válida.');
        window.close();
        return;
      }

      // org_status global (acceso mínimo a app)
      const orgStatus = await getOrgStatus();
      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        alert('No tienes acceso a la aplicación.');
        window.close();
        return;
      }

      // Permisos módulo usuarios
      const { data: meRow, error: meError } = await supa
        .from('users')
        .select('tesoro_internal_role')
        .eq('id', session.user.id)
        .maybeSingle();

      if (meError) console.error('Error leyendo rol interno propio:', meError);

      let myRole = meRow?.tesoro_internal_role || null;
      if (typeof myRole === 'string') myRole = myRole.trim();

      let appRoleRow = null;
      if (myRole) {
        const asNumber = Number(myRole);
        if (!Number.isNaN(asNumber) && myRole !== '') {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .eq('id', asNumber)
            .maybeSingle();
          if (!error) appRoleRow = data;
        }

        if (!appRoleRow) {
          const { data, error } = await supa
            .from('roles_app')
            .select('*')
            .ilike('role_name', myRole)
            .maybeSingle();
          if (!error) appRoleRow = data;
        }
      }

      const usersLevel = appRoleRow?.usuarios ?? 0;
      const readOnly   = (usersLevel === 1);

      if (!usersLevel || usersLevel === 0) {
        alert('No tienes acceso al módulo de Usuarios.');
        window.close();
        return;
      }

      const permsLabel = document.getElementById('user-perms-label');
      permsLabel.textContent = readOnly
        ? 'Permisos: solo lectura. No puedes editar usuarios.'
        : 'Permisos: edición habilitada. No puedes modificar tu propio rol/org_status.';

      // --- Referencias a campos ---
      const roleSelect     = document.getElementById('u_role_internal');
      const orgSelect      = document.getElementById('u_org_status');
      const handleInput    = document.getElementById('u_handle');
      const discordInput   = document.getElementById('u_discord');
      const createdInput   = document.getElementById('u_created');
      const lastLoginInput = document.getElementById('u_last_login');
      const saveBtn        = document.getElementById('btn-save');
      const closeBtn       = document.getElementById('btn-close');

      // 1) Cargar roles_app para combo de rol interno
      const { data: rolesApp, error: rolesError } = await supa
        .from('roles_app')
        .select('role_name')
        .order('id', { ascending: true });

      if (rolesError) console.error('Error cargando roles_app:', rolesError);

      (rolesApp || []).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.role_name;
        opt.textContent = r.role_name;
        roleSelect.appendChild(opt);
      });

      // 2) Cargar roles de Discord para org_status (public.discord_roles)
      const { data: orgRoles, error: orgRolesError } = await supa
        .from('discord_roles')
        .select('name, mapped_org_status')
        .order('id', { ascending: true });

      if (orgRolesError) {
        console.error('Error cargando discord_roles:', orgRolesError);
      }

      // Rellenamos el select de org_status con Name visible y value = mapped_org_status
      (orgRoles || []).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.mapped_org_status;   // ej: "miembro"
        opt.textContent = r.name;          // ej: "Miembro"
        orgSelect.appendChild(opt);
      });

      // 3) Cargar usuario a editar
      const { data: userRow, error: userError } = await supa
        .from('users')
        .select('id, handle_name, discord_username, org_status, tesoro_internal_role, created_at, last_login_at')
        .eq('id', userId)
        .maybeSingle();

      if (userError || !userRow) {
        console.error('Error leyendo usuario:', userError);
        alert('No se ha podido cargar la información del usuario.');
        window.close();
        return;
      }

      const isSelf = (userRow.id === session.user.id);

      function fillForm(u) {
        handleInput.value    = u.handle_name || '';
        discordInput.value   = cleanDiscordUsername(u.discord_username || '');
        createdInput.value   = u.created_at ? new Date(u.created_at).toLocaleString() : '-';
        lastLoginInput.value = u.last_login_at ? new Date(u.last_login_at).toLocaleString() : '-';

        roleSelect.value = u.tesoro_internal_role || '';

        // Si no tiene org_status, por defecto "afiliado" (si existe en la tabla)
        const currentOrg = u.org_status || 'afiliado';
        orgSelect.value = currentOrg;

        // Si por lo que sea el valor no existe en el select, lo dejamos sin seleccionar
        if (orgSelect.value !== currentOrg) {
          orgSelect.value = '';
        }
      }

      fillForm(userRow);

      // 4) Aplicar permisos a los campos
      if (readOnly) {
        handleInput.readOnly = true;
        roleSelect.disabled  = true;
        orgSelect.disabled   = true;
        saveBtn.classList.add('btn-disabled');
      } else {
        // Nivel edición
        handleInput.readOnly = false;
        saveBtn.classList.remove('btn-disabled');

        if (isSelf) {
          // No te cambias tu propio rol/org_status
          roleSelect.disabled = true;
          orgSelect.disabled  = true;
        } else {
          roleSelect.disabled = false;
          orgSelect.disabled  = false;
        }
      }

      // Botón cerrar
      closeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        window.close();
      });

      // Guardar cambios
      const form = document.getElementById('user-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (readOnly) {
          alert('Tienes permisos de solo lectura en este módulo.');
          return;
        }

        const updates = {
          handle_name: handleInput.value.trim() || null
        };

        if (!isSelf) {
          updates.tesoro_internal_role = roleSelect.value || null;
          updates.org_status           = orgSelect.value || null; // siempre uno de mapped_org_status
        }

        const { error: updError } = await supa
          .from('users')
          .update(updates)
          .eq('id', userRow.id);

        if (updError) {
          console.error('Error actualizando usuario:', updError);
          alert('No se han podido guardar los cambios.');
          return;
        }

        // Recargar datos del usuario y refrescar formulario
        const { data: refreshed, error: refError } = await supa
          .from('users')
          .select('id, handle_name, discord_username, org_status, tesoro_internal_role, created_at, last_login_at')
          .eq('id', userRow.id)
          .maybeSingle();

        if (!refError && refreshed) {
          fillForm(refreshed);
        }

        alert('Usuario actualizado correctamente.');
      });
    });
  </script>
</body>
</html>
