<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Panel</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.app-main {
      padding: 1.5rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1.3rem;
    }

    .card-link {
      display: block;
      padding: 1.2rem;
      border-radius: 0.8rem;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.3);
      transition: background .15s, border-color .15s;
      cursor: pointer;
      text-decoration: none;
      color: #e5e7eb;
    }

    .card-link:hover {
      background: #0f172a;
      border-color: rgba(148,163,184,0.6);
    }

    .card-link h3 {
      margin: 0 0 .4rem 0;
      font-size: 1.1rem;
    }

    .card-link p {
      margin: 0;
      opacity: .75;
      font-size: .85rem;
    }
  </style>
</head>

<body>
  <div id="site-header"></div>

  <main class="app-main">
    <div style="margin-bottom:1.2rem;">
      <h2>Panel del Tesoro</h2>
      <p style="opacity:.8;margin-top:.2rem;font-size:.9rem;">
        Acceso a todos los módulos operativos del Departamento del Tesoro.
      </p>
    </div>

    <div class="grid">

      <a class="card-link" href="./solicitudes.html">
        <h3>Solicitudes</h3>
        <p>Crear y consultar solicitudes propias.</p>
      </a>

      <a class="card-link" href="./revision.html">
        <h3>Revisión</h3>
        <p>Revisar, aprobar o rechazar solicitudes.</p>
      </a>

      <a class="card-link" href="./registro.html">
        <h3>Registro</h3>
        <p>Historial completo de solicitudes.</p>
      </a>

      <a class="card-link" href="./almacenes.html">
        <h3>Almacenes</h3>
        <p>Gestión y consulta del inventario por almacén.</p>
      </a>

      <a class="card-link" href="./usuarios.html">
        <h3>Usuarios</h3>
        <p>Gestión de usuarios del tesoro.</p>
      </a>

      <a class="card-link" href="./perfil.html">
        <h3>Mi perfil</h3>
        <p>Datos de cuenta y configuración personal.</p>
      </a>

    </div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 1) Sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = './index.html';
        return;
      }

      // 2) org_status
      const orgStatus = await getOrgStatus();

      if (!orgStatus || !['miembro','daga','espada','admin'].includes(orgStatus)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // 3) Header
      if (typeof window.loadHeader === 'function') {
        await window.loadHeader('app');
      }

      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => {
            await supa.auth.signOut();
            window.location.href = "./index.html";
          },
          () => window.location.href = './perfil.html'
        );
      }
    });
  </script>

</body>
</html>
