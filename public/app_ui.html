<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventario — Panel</title>
  <link rel="stylesheet" href="./style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/auth.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // 1) Comprobar sesión
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        // Si no hay sesión, fuera al login
        window.location.href = "./index.html";
        return;
      }

      // 2) Rellenar datos de usuario
      const profile = session.user;
      const avatar = profile?.user_metadata?.avatar_url || '';
      const name = profile?.user_metadata?.name || profile?.email || 'Invitado';
      document.getElementById('whoami').textContent = name;
      if (avatar) document.getElementById('avatar').src = avatar;

      // 3) Botón salir
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          await supa.auth.signOut();
          window.location.href = "./index.html";
        });
      }

      // 4) Cargar datos
      loadItems();
      loadRequests();
    });

    async function loadItems(){
      const { supa } = window;
      const { data, error } = await supa.from('items').select('*').order('name');
      if(error){ console.error(error); return; }
      const tbody = document.querySelector('#items tbody');
      tbody.innerHTML = '';
      (data||[]).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.name}</td>
          <td>${it.type||''}</td>
          <td>${it.quantity}</td>
          <td>${it.unit_value ?? '-'}</td>
          <td>${it.location||'-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function createRequest(e){
      e.preventDefault();
      const { supa } = window;
      const form = e.target;
      const item_id = form.item_id.value;
      const quantity = Number(form.quantity.value);
      const { data: { session } } = await supa.auth.getSession();
      if(!session){ 
        alert('Necesitas iniciar sesión con Discord.');
        window.location.href = "./index.html";
        return; 
      }
      const requester = session.user.id;
      const { error } = await supa.from('requests')
        .insert({ item_id, quantity, requester_discord_id: requester, status: 'pendiente' });
      if(error){ 
        alert('Error creando solicitud: '+error.message); 
        return; 
      }
      form.reset();
      loadRequests();
      alert('Solicitud creada');
    }

    async function loadRequests(){
      const { supa } = window;
      const { data, error } = await supa.from('requests')
        .select('id,item_id,quantity,status,created_at,items(name)')
        .order('created_at', { ascending:false });
      if(error){ console.error(error); return; }
      const tbody = document.querySelector('#requests tbody');
      tbody.innerHTML='';
      (data||[]).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>#${r.id}</td>
          <td>${r.items?.name||'-'}</td>
          <td>${r.quantity}</td>
          <td><span class="badge">${r.status}</span></td>
          <td>${new Date(r.created_at).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>
</head>
<body>
  <header class="topbar">
  <div class="topbar-left">
    <img src="./assets/logo.png" alt="logo" class="logo"/>
  </div>

  <div class="topbar-center">
    <h3>DEPARTAMENTO DEL TESORO DE ALFILO</h3>
  </div>

  <div class="topbar-right">
    <div class="user-menu">
      <button class="avatar-button" id="avatar-button">
        <img src="./assets/logo.png" alt="avatar" id="avatar"/>
      </button>
      <div class="user-menu-dropdown" id="user-dropdown">
        <div class="user-menu-name" id="user-name"></div>
        <button type="button" id="profile-btn">Perfil</button>
        <button type="button" id="logout-btn">Cerrar sesión</button>
      </div>
    </div>
  </div>
</header>
  <main>
    <div class="card">
      <h2>Inventario</h2>
      <table class="table" id="items">
        <thead><tr><th>Nombre</th><th>Tipo</th><th>Stock</th><th>Valor</th><th>Ubicación</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Nueva solicitud</h2>
      <form class="row" onsubmit="createRequest(event)">
        <input name="item_id" placeholder="ID de item (demo)" required/>
        <input type="number" name="quantity" min="1" placeholder="Cantidad" required/>
        <button>Enviar solicitud</button>
      </form>
      <p style="opacity:.7;margin-top:.5rem">*En una versión completa, seleccionas el ítem desde la tabla.</p>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Mis solicitudes (demo)</h2>
      <table class="table" id="requests">
        <thead><tr><th>ID</th><th>Ítem</th><th>Cant.</th><th>Estado</th><th>Creada</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</body>
</html>
