<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Panel</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.tesoro-main {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1.2rem;
      margin-top: 2rem;
    }

    .module-card {
      cursor: pointer;
      transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s;
      border-radius: 0.75rem;
      padding: 1.2rem;
    }

    .module-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 26px rgba(0,0,0,0.45);
      border-color: rgba(120,200,255,0.45);
    }

    .module-chip {
      font-size: .75rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      opacity: .8;
      border: 1px solid rgba(255,255,255,0.25);
      margin-bottom: .4rem;
      display: inline-block;
    }

    .module-card h3 {
      margin: 0 0 .4rem;
    }

    .module-card p {
      margin: 0;
      opacity: .75;
      font-size: .9rem;
      line-height: 1.3rem;
    }

    /* Estado deshabilitado por permisos */
    .module-card.disabled {
      opacity: 0.45;
      cursor: not-allowed;
      filter: grayscale(0.4);
      border-color: rgba(248, 113, 113, 0.6); /* rojizo suave */
    }

    .module-card.disabled:hover {
      transform: none;
      box-shadow: none;
    }
  </style>
</head>

<body>

  <!-- Aquí se inyecta components/header.html -->
  <div id="site-header"></div>

  <main class="tesoro-main">
    <h2>Panel del Departamento del Tesoro</h2>
    <p style="opacity:.8;margin-top:.25rem">Selecciona un módulo.</p>

    <div class="modules-grid">

      <div class="card module-card" data-module="solicitudes">
        <span class="module-chip">Operaciones</span>
        <h3>Solicitudes</h3>
        <p>Crear y consultar solicitudes de retirada, préstamo o consumo.</p>
      </div>

      <div class="card module-card" data-module="revision">
        <span class="module-chip">Encargados</span>
        <h3>Revisión</h3>
        <p>Bandeja para aprobar, denegar o modificar solicitudes.</p>
      </div>

      <div class="card module-card" data-module="inventario">
        <span class="module-chip">Stock</span>
        <h3>Inventario</h3>
        <p>Listado y estado del stock general del Tesoro.</p>
      </div>

      <div class="card module-card" data-module="almacenes">
        <span class="module-chip">Logística</span>
        <h3>Almacenes</h3>
        <p>Gestión de ubicaciones, hangares y contenedores.</p>
      </div>

      <div class="card module-card" data-module="registro">
        <span class="module-chip">Auditoría</span>
        <h3>Registro</h3>
        <p>Histórico de movimientos y trazabilidad completa.</p>
      </div>

      <div class="card module-card" data-module="calendario">
        <span class="module-chip">Planificación</span>
        <h3>Calendario</h3>
        <p>Vista de calendario con los movimientos distribuidos por el día en que se producen.</p>
      </div>

      <div class="card module-card" data-module="usuarios">
        <span class="module-chip">Administración</span>
        <h3>Usuarios</h3>
        <p>Gestión de usuarios, permisos internos del Tesoro y datos de cada miembro.</p>
      </div>

    </div>
  </main>

  <script type="module">
  import { getOrgStatus } from './modules/profile.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const { supa } = window;

    // --- 1) Comprobar sesión ---
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      window.location.href = './index.html';
      return;
    }

    // --- 2) Comprobar rol de organización permitido (miembro de la org) ---
    const status = await getOrgStatus();
    if (!status || !['miembro','daga','espada','admin'].includes(status)) {
      await supa.auth.signOut();
      window.location.href = './index.html';
      return;
    }

    // --- 3) Cargar header existente ---
    await loadHeader('app');

    // --- 4) Inicializar menú usuario del header ---
    if (typeof window.initHeaderUserMenu === 'function') {
      window.initHeaderUserMenu(
        session,
        async () => {
          await supa.auth.signOut();
          window.location.href = "./index.html";
        },
        () => {
          window.location.href = './perfil.html';
        }
      );
    }

    // --- 5) Obtener rol interno del usuario desde public.users ---
    const { data: userRow, error: userError } = await supa
      .from('users')
      .select('tesoro_internal_role')
      .eq('id', session.user.id)
      .maybeSingle();

    if (userError) {
      console.error('Error leyendo tesoro_internal_role:', userError);
    }

    let internalRole = userRow?.tesoro_internal_role || null;
    if (typeof internalRole === 'string') internalRole = internalRole.trim();
    console.log('Rol interno detectado:', internalRole);

    // --- 6) Buscar fila de permisos en roles_app ---
    let roleRow = null;

    if (internalRole) {
      // ¿Numérico? → lo tratamos como id de roles_app
      const asNumber = Number(internalRole);
      if (!Number.isNaN(asNumber) && internalRole !== '') {
        const { data, error } = await supa
          .from('roles_app')
          .select('*')
          .eq('id', asNumber)
          .maybeSingle();

        if (error) {
          console.error('Error buscando rol por id en roles_app:', error);
        } else {
          roleRow = data;
        }
      }

      // Si no hemos encontrado nada por id, probamos por nombre (case-insensitive)
      if (!roleRow) {
        const { data, error } = await supa
          .from('roles_app')
          .select('*')
          .ilike('role_name', internalRole) // "Admin" == "admin"
          .maybeSingle();

        if (error) {
          console.error('Error buscando rol por nombre en roles_app:', error);
        } else {
          roleRow = data;
        }
      }
    }

    if (!roleRow) {
      console.warn('No se encontró fila de roles_app para rol interno:', internalRole);
    } else {
      console.log('Fila de permisos cargada de roles_app:', roleRow);
    }

    // --- 6.1 Normalizar columnas de permisos (lowercase) ---
    const permsByModule = {};
    if (roleRow) {
      for (const [key, value] of Object.entries(roleRow)) {
        // columnas que NO son módulos
        if (['id', 'role_name', 'created_at', 'updated_at'].includes(key)) continue;
        // pasamos el nombre de la columna a minúsculas
        const normKey = key.toLowerCase();
        permsByModule[normKey] = value;
      }
    }
    console.log('Mapa de permisos por módulo (normalizado):', permsByModule);

    // --- 7) Aplicar permisos a las tarjetas de módulos ---
    const cards = document.querySelectorAll('.module-card');

    cards.forEach(card => {
      const mod = card.getAttribute('data-module'); // ej. "solicitudes"
      const normMod = mod.toLowerCase();

      // Si no hay fila de permisos o no hay columna para ese módulo → 0
      const level = permsByModule.hasOwnProperty(normMod)
        ? (permsByModule[normMod] ?? 0)
        : 0;

      if (!level || level === 0) {
        card.classList.add('disabled');
      }

      card.addEventListener('click', () => {
        const currentLevel = permsByModule.hasOwnProperty(normMod)
          ? (permsByModule[normMod] ?? 0)
          : 0;

        if (!currentLevel || currentLevel === 0) {
          alert('No tienes acceso a este módulo.');
          return;
        }

        // Aquí más adelante redirigiremos según "mod" y diferenciaremos 1/2
        alert(`Módulo "${mod}" aún no está implementado (nivel ${currentLevel}).`);
      });
    });
  });
</script>

</body>
</html>
