<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventario ‚Äî Panel</title>
  <link rel="stylesheet" href="./style.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/auth.js" defer></script>
  <script src="./modules/layout.js" defer></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const { supa } = window;

    // 1) Cargar header com√∫n (variante "app" = con avatar + men√∫)
    await loadHeader('app');

    // 2) Comprobar sesi√≥n
    const { data: { session }, error } = await supa.auth.getSession();
    console.log('session en app_ui:', session, 'error:', error);

    if (!session) {
      window.location.href = "./index.html";
      return;
    }

    // 3) Inicializar avatar + men√∫ con esa sesi√≥n
    initHeaderUserMenu(
      session,
      async () => { // onLogout
        await supa.auth.signOut();
        window.location.href = "./index.html";
      },
      () => { // onProfile
        alert('Vista de perfil pendiente de implementar üòÑ');
      }
    );

    // 4) Cargar datos
    loadItems();
    loadRequests();
  });

  async function loadItems(){
    const { supa } = window;
    const { data, error } = await supa.from('items').select('*').order('name');
    if(error){ console.error('error loadItems:', error); return; }
    const tbody = document.querySelector('#items tbody');
    tbody.innerHTML = '';
    (data||[]).forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.name}</td>
        <td>${it.type||''}</td>
        <td>${it.quantity}</td>
        <td>${it.unit_value ?? '-'}</td>
        <td>${it.location||'-'}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function createRequest(e){
    e.preventDefault();
    const { supa } = window;
    const form = e.target;
    const item_id = form.item_id.value;
    const quantity = Number(form.quantity.value);

    const { data: { session } } = await supa.auth.getSession();
    if(!session){
      alert('Necesitas iniciar sesi√≥n con Discord.');
      window.location.href = "./index.html";
      return;
    }

    const requester = session.user.id;
    const { error } = await supa
      .from('requests')
      .insert({ item_id, quantity, requester_discord_id: requester, status: 'pendiente' });

    if(error){
      alert('Error creando solicitud: ' + error.message);
      return;
    }

    form.reset();
    loadRequests();
    alert('Solicitud creada');
  }

  async function loadRequests(){
    const { supa } = window;
    const { data, error } = await supa.from('requests')
      .select('id,item_id,quantity,status,created_at,items(name)')
      .order('created_at', { ascending:false });

    if(error){ console.error('error loadRequests:', error); return; }

    const tbody = document.querySelector('#requests tbody');
    tbody.innerHTML='';
    (data||[]).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>#${r.id}</td>
        <td>${r.items?.name||'-'}</td>
        <td>${r.quantity}</td>
        <td><span class="badge">${r.status}</span></td>
        <td>${new Date(r.created_at).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }
</script>
</head>
<body>
  <div id="site-header"></div>
  <main>
    <div class="card">
      <h2>Inventario</h2>
      <table class="table" id="items">
        <thead><tr><th>Nombre</th><th>Tipo</th><th>Stock</th><th>Valor</th><th>Ubicaci√≥n</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Nueva solicitud</h2>
      <form class="row" onsubmit="createRequest(event)">
        <input name="item_id" placeholder="ID de item (demo)" required/>
        <input type="number" name="quantity" min="1" placeholder="Cantidad" required/>
        <button>Enviar solicitud</button>
      </form>
      <p style="opacity:.7;margin-top:.5rem">*En una versi√≥n completa, seleccionas el √≠tem desde la tabla.</p>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Mis solicitudes (demo)</h2>
      <table class="table" id="requests">
        <thead><tr><th>ID</th><th>√çtem</th><th>Cant.</th><th>Estado</th><th>Creada</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</body>
</html>
