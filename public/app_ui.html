<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventario — Panel</title>
  <link rel="stylesheet" href="./style.css"/>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/auth.js" defer></script>
  <script src="./modules/layout.js" defer></script>
</head>
<body>

  <!-- HEADER (modo app) -->
  <div id="site-header"></div>

  <main>
    <div class="card">
      <h2>Inventario</h2>
      <table class="table" id="items">
        <thead>
          <tr><th>Nombre</th><th>Tipo</th><th>Stock</th><th>Valor</th><th>Ubicación</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Nueva solicitud</h2>
      <form class="row" onsubmit="createRequest(event)">
        <input name="item_id" placeholder="ID de item (demo)" required/>
        <input type="number" name="quantity" min="1" placeholder="Cantidad" required/>
        <button>Enviar solicitud</button>
      </form>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Mis solicitudes</h2>
      <table class="table" id="requests">
        <thead>
          <tr><th>ID</th><th>Ítem</th><th>Cant.</th><th>Estado</th><th>Creada</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

<script type="module">
  import { getOrgStatus } from './modules/profile.js';

  // ==========================================================
  // VALIDACIÓN DE ACCESO ANTES DE CARGAR EL PANEL
  // ==========================================================
  document.addEventListener('DOMContentLoaded', async () => {
    const { supa } = window;

    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      window.location.href = './index.html';
      return;
    }

    const status = await getOrgStatus();
    if (!status || !['miembro','daga','espada','admin'].includes(status)) {
      await supa.auth.signOut();
      window.location.href = './index.html';
      return;
    }

    // --- HEADER ---
    await loadHeader('app');

    initHeaderUserMenu(
      session,
      async () => { await supa.auth.signOut(); window.location.href='./index.html'; },
      () => { alert('Vista de perfil pendiente'); }
    );

    loadItems();
    loadRequests();
  });

  // ==========================================================
  // FUNCIONES DEL PANEL
  // ==========================================================
  async function loadItems(){
    const { supa } = window;
    const { data, error } = await supa.from('items').select('*').order('name');
    if(error){ console.error(error); return; }
    const tbody = document.querySelector('#items tbody');
    tbody.innerHTML='';
    (data||[]).forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${it.name}</td>
        <td>${it.type||''}</td>
        <td>${it.quantity}</td>
        <td>${it.unit_value ?? '-'}</td>
        <td>${it.location||'-'}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function createRequest(e){
    e.preventDefault();
    const { supa } = window;
    const form = e.target;

    const { data: { session } } = await supa.auth.getSession();
    if(!session) return window.location.href='./index.html';

    const { error } = await supa.from('requests').insert({
      item_id: form.item_id.value,
      quantity: Number(form.quantity.value),
      requester_discord_id: session.user.id,
      status: 'pendiente'
    });

    if(error){
      alert('Error creando solicitud: ' + error.message);
      return;
    }

    form.reset();
    loadRequests();
  }

  async function loadRequests(){
    const { supa } = window;
    const { data, error } = await supa.from('requests')
      .select('id,item_id,quantity,status,created_at,items(name)')
      .order('created_at', { ascending:false });

    if(error){ console.error(error); return; }

    const tbody = document.querySelector('#requests tbody');
    tbody.innerHTML='';
    (data||[]).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>#${r.id}</td>
        <td>${r.items?.name||'-'}</td>
        <td>${r.quantity}</td>
        <td><span class="badge">${r.status}</span></td>
        <td>${new Date(r.created_at).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Necesario para el onsubmit="createRequest(event)"
  window.createRequest = createRequest;
</script>

</body>
</html>
