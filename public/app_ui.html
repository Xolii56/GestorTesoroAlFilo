<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Departamento del Tesoro — Panel</title>
  <link rel="stylesheet" href="./style.css"/>

  <!-- Supabase + módulos -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./config.js" defer></script>
  <script src="./modules/db.js" defer></script>
  <script src="./modules/layout.js" defer></script>

  <style>
    main.tesoro-main {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1.2rem;
      margin-top: 2rem;
    }

    .module-card {
      cursor: pointer;
      transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s;
      border-radius: 0.75rem;
      padding: 1.2rem;
    }

    .module-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 26px rgba(0,0,0,0.45);
      border-color: rgba(120,200,255,0.45);
    }

    .module-chip {
      font-size: .75rem;
      padding: .15rem .55rem;
      border-radius: 999px;
      opacity: .8;
      border: 1px solid rgba(255,255,255,0.25);
      margin-bottom: .4rem;
      display: inline-block;
    }

    .module-card h3 {
      margin: 0 0 .4rem;
    }

    .module-card p {
      margin: 0;
      opacity: .75;
      font-size: .9rem;
      line-height: 1.3rem;
    }
  </style>
</head>

<body>

  <!-- Aquí se inyecta components/header.html -->
  <div id="site-header"></div>

  <main class="tesoro-main">
    <h2>Panel del Departamento del Tesoro</h2>
    <p style="opacity:.8;margin-top:.25rem">Selecciona un módulo.</p>

    <div class="modules-grid">

      <div class="card module-card" data-module="solicitudes">
        <span class="module-chip">Operaciones</span>
        <h3>Solicitudes</h3>
        <p>Crear y consultar solicitudes de retirada, préstamo o consumo.</p>
      </div>

      <div class="card module-card" data-module="revision">
        <span class="module-chip">Encargados</span>
        <h3>Revisión</h3>
        <p>Bandeja para aprobar, denegar o modificar solicitudes.</p>
      </div>

      <div class="card module-card" data-module="inventario">
        <span class="module-chip">Stock</span>
        <h3>Inventario</h3>
        <p>Listado y estado del stock general del Tesoro.</p>
      </div>

      <div class="card module-card" data-module="almacenes">
        <span class="module-chip">Logística</span>
        <h3>Almacenes</h3>
        <p>Gestión de ubicaciones, hangares y contenedores.</p>
      </div>

      <div class="card module-card" data-module="registro">
        <span class="module-chip">Auditoría</span>
        <h3>Registro</h3>
        <p>Histórico de movimientos y trazabilidad completa.</p>
      </div>

      <div class="card module-card" data-module="calendario">
        <span class="module-chip">Planificación</span>
        <h3>Calendario</h3>
        <p>Vista de calendario con los movimientos distribuidos por el día en que se producen.</p>
      </div>

      <div class="card module-card" data-module="usuarios">
        <span class="module-chip">Administración</span>
        <h3>Usuarios</h3>
        <p>Gestión de usuarios, permisos internos del Tesoro y datos de cada miembro.</p>
      </div>

    </div>
  </main>

  <script type="module">
    import { getOrgStatus } from './modules/profile.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const { supa } = window;

      // --- 1) Comprobar sesión ---
      const { data: { session } } = await supa.auth.getSession();
      if (!session) {
        window.location.href = './index.html';
        return;
      }

      // --- 2) Comprobar rol permitido ---
      const status = await getOrgStatus();
      if (!status || !['miembro','daga','espada','admin'].includes(status)) {
        await supa.auth.signOut();
        window.location.href = './index.html';
        return;
      }

      // --- 3) Cargar header existente ---
      await loadHeader('app');

      // --- 4) Inicializar menú usuario del header ---
      if (typeof window.initHeaderUserMenu === 'function') {
        window.initHeaderUserMenu(
          session,
          async () => {
            await supa.auth.signOut();
            window.location.href = "./index.html";
          },
          () => {
            // Ir a la página de perfil
            window.location.href = './perfil.html';
          }
        );
      }

      // --- 5) Módulos (placeholder) ---
      document.querySelectorAll('.module-card').forEach(card => {
        card.addEventListener('click', () => {
          const mod = card.getAttribute('data-module');
          alert(`Módulo "${mod}" aún no está implementado.`);
        });
      });
    });
  </script>

</body>
</html>
